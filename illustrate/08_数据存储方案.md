# 数据存储方案

## 一、概述

### 1.1 适用范围
本文档定义EMS系统的数据存储方案，包括日志、配置、历史数据的存储格式和管理策略。

### 1.2 存储介质
| 介质类型 | 容量 | 用途 | 说明 |
|----------|------|------|------|
| eMMC | 8GB+ | 系统+应用+数据 | RK3566主存储 |
| SD卡 | 可选 | 历史数据备份 | 扩展存储 |

### 1.3 存储约束
| 约束项 | 限制值 | 说明 |
|--------|--------|------|
| 日志总容量 | 500MB | 超限自动轮转 |
| 配置文件大小 | 1MB | 单文件上限 |
| 历史数据保留 | 30天 | 超期自动清理 |

### 1.4 写入频率约束
为保护Flash寿命，各类数据写入频率限制如下：

| 数据类型 | 最大写入频率 | 说明 |
|----------|--------------|------|
| 历史数据落盘 | 1次/秒 | 内存缓冲后批量写入 |
| SQLite事务提交 | 1次/秒 | 告警/统计数据 |
| 配置文件写入 | 无限制 | 仅用户操作触发，频率极低 |
| 日志写入 | 无限制 | 使用缓冲，定期刷盘 |

> **说明**：历史数据和SQLite的1次/秒限制通过内存缓冲实现，采集周期仍为1秒，但落盘操作合并执行。日志使用stdio缓冲，由系统自动管理刷盘时机。

---

## 二、存储路径规划

### 2.1 目录结构
```
/opt/ems/                       # EMS应用根目录
├── bin/                        # 可执行文件
│   └── ems                     # EMS主程序
├── config/                     # 配置文件目录
│   ├── system.json             # 系统配置
│   ├── devices.json            # 设备配置
│   └── network.json            # 网络配置
├── data/                       # 运行数据目录
│   ├── history/                # 历史数据
│   │   ├── 2025-12-30/         # 按日期分目录
│   │   │   ├── foc.dat         # FOC历史数据
│   │   │   ├── bms.dat         # BMS历史数据
│   │   │   └── charger.dat     # 充电桩历史数据
│   │   └── ...
│   ├── alarms.db               # 告警记录(SQLite)
│   └── statistics.db           # 统计数据(SQLite)
├── log/                        # 日志目录
│   ├── ems.log                 # 当前日志
│   ├── ems.log.1               # 轮转日志
│   ├── ems.log.2
│   └── ...
└── tmp/                        # 临时文件目录
    └── ota/                    # OTA升级临时目录
```

### 2.2 路径与权限说明

**目录权限**：
| 路径 | 目录权限 | 所有者 | 说明 |
|------|----------|--------|------|
| /opt/ems/ | 755 (rwxr-xr-x) | root:ems | 应用根目录 |
| /opt/ems/bin/ | 755 (rwxr-xr-x) | root:ems | 程序文件目录 |
| /opt/ems/config/ | 755 (rwxr-xr-x) | ems:ems | 配置文件目录 |
| /opt/ems/data/ | 755 (rwxr-xr-x) | ems:ems | 运行数据目录 |
| /opt/ems/log/ | 755 (rwxr-xr-x) | ems:ems | 日志文件目录 |
| /opt/ems/tmp/ | 1777 (rwxrwxrwt) | root:root | 临时文件目录 |

**文件权限**：
| 文件类型 | 文件权限 | 说明 |
|----------|----------|------|
| 可执行文件 | 755 (rwxr-xr-x) | bin/ems |
| 配置文件 | 644 (rw-r--r--) | *.json |
| 日志文件 | 644 (rw-r--r--) | *.log |
| 数据文件 | 644 (rw-r--r--) | *.dat, *.db |

> **注意**：目录需要执行权限(x)才能进入，因此目录权限至少为755；文件权限644表示所有者可读写、其他用户只读。

---

## 三、日志存储

### 3.1 日志级别
| 级别 | 值 | 说明 | 输出目标 |
|------|-----|------|----------|
| ERROR | 0 | 错误，需要关注 | 文件+控制台 |
| WARN | 1 | 警告，可能有问题 | 文件+控制台 |
| INFO | 2 | 信息，正常运行 | 文件 |
| DEBUG | 3 | 调试，开发使用 | 文件(可选) |
| TRACE | 4 | 跟踪，详细信息 | 文件(可选) |

### 3.2 日志格式
```
[时间戳] [级别] [模块] [msg_id] 消息内容
```

**示例**：
```
[2025-12-30 10:00:00.123] [INFO] [COMM] [550e8400-...] 收到FOC状态查询请求
[2025-12-30 10:00:00.156] [INFO] [COMM] [550e8400-...] 返回FOC状态响应
[2025-12-30 10:00:01.000] [WARN] [BMS] [-] BMS001温度接近阈值: 43.5°C
[2025-12-30 10:00:05.000] [ERROR] [FOC] [-] FOC001通讯超时
```

**字段说明**：
| 字段 | 格式 | 说明 |
|------|------|------|
| 时间戳 | YYYY-MM-DD HH:MM:SS.mmm | 毫秒精度 |
| 级别 | ERROR/WARN/INFO/DEBUG/TRACE | 日志级别 |
| 模块 | MAIN/COMM/FOC/BMS/CHARGER/ALARM | 功能模块 |
| msg_id | UUID或- | 消息追踪ID，无则为- |

### 3.3 日志轮转策略
| 参数 | 值 | 说明 |
|------|-----|------|
| 单文件大小 | 10MB | 超限触发轮转 |
| 保留文件数 | 50 | 最多保留50个文件 |
| 总容量上限 | 500MB | 超限删除最旧文件 |
| 轮转方式 | 重命名 | ems.log → ems.log.1 |
| 压缩 | 否 | 保持可读性 |

### 3.4 日志模块定义
| 模块名 | 说明 |
|--------|------|
| MAIN | 主程序、系统级 |
| COMM | 通讯层（终端、设备） |
| FOC | FOC电机控制 |
| BMS | BMS电池管理 |
| CHARGER | 充电桩 |
| ALARM | 告警处理 |
| CONFIG | 配置管理 |
| OTA | 固件升级 |

---

## 四、配置存储

### 4.1 配置文件列表
| 文件名 | 用途 | 格式 | 热加载 |
|--------|------|------|--------|
| system.json | 系统配置 | JSON | 否 |
| devices.json | 设备配置 | JSON | 是 |
| network.json | 网络配置 | JSON | 否 |

### 4.2 配置文件格式

#### 4.2.1 system.json
```json
{
  "version": "1.0",
  "log": {
    "level": "INFO",
    "max_size_mb": 10,
    "max_files": 50
  },
  "data": {
    "history_days": 30,
    "sample_interval_ms": 1000
  },
  "terminal": {
    "port": 9000,
    "max_connections": 5,
    "heartbeat_timeout_s": 30
  }
}
```

#### 4.2.2 devices.json
```json
{
  "version": "1.0",
  "foc_devices": [
    {
      "device_id": "FOC001",
      "modbus_addr": 1,
      "serial_port": "/dev/ttyS3",
      "baudrate": 115200,
      "enabled": true
    }
  ],
  "bms_devices": [
    {
      "device_id": "BMS001",
      "asdu_addr": 1,
      "ip": "192.168.1.101",
      "port": 2404,
      "enabled": true
    }
  ],
  "charger_devices": [
    {
      "device_id": "CP001",
      "charge_point_id": "CP001",
      "enabled": true
    }
  ]
}
```

#### 4.2.3 network.json
```json
{
  "version": "1.0",
  "wifi": {
    "mode": "ap",
    "ssid": "EMS_AP",
    "password": "ems12345",
    "channel": 6
  },
  "eth": {
    "enabled": false,
    "dhcp": true,
    "ip": "",
    "netmask": "",
    "gateway": ""
  }
}
```

### 4.3 配置读写规则
| 操作 | 规则 |
|------|------|
| 读取 | 启动时加载，缓存到内存 |
| 写入 | 先写临时文件，再原子替换 |
| 校验 | 写入前校验JSON格式和字段 |
| 备份 | 写入前备份原文件为.bak |
| 默认值 | 字段缺失时使用默认值 |

### 4.4 热加载支持范围

#### 4.4.1 各配置文件热加载能力
| 配置文件 | 热加载 | 说明 |
|----------|--------|------|
| system.json | 否 | 需重启EMS生效 |
| devices.json | 部分 | 见下表详细说明 |
| network.json | 否 | 需重启EMS生效 |

#### 4.4.2 devices.json字段热加载详情
| 字段 | 热加载 | 说明 |
|------|--------|------|
| enabled | 是 | 可动态启用/禁用设备 |
| 其他字段 | 否 | 修改后需重启生效 |

#### 4.4.3 热加载失败处理
| 场景 | 处理策略 |
|------|----------|
| JSON格式错误 | 拒绝加载，保持原配置，返回错误 |
| 字段校验失败 | 拒绝加载，保持原配置，返回错误 |
| 设备启用失败 | 该设备保持原状态，其他设备正常更新 |

> **说明**：热加载采用"全部成功或全部失败"策略（设备enabled字段除外），避免部分生效导致配置不一致。

### 4.5 配置变更流程
```
1. 接收配置写入请求
2. 校验JSON格式
3. 校验字段类型和范围
4. 备份原文件 → <配置文件>.bak
5. 写入临时文件 → <配置文件>.tmp
6. 原子重命名 → <配置文件>
7. 需要时重新加载配置

示例：写入devices.json
  备份 → devices.json.bak
  临时 → devices.json.tmp
  目标 → devices.json
```

---

## 五、历史数据存储

### 5.1 数据类型
| 类型 | 采集周期 | 存储格式 | 说明 |
|------|----------|----------|------|
| FOC状态 | 1秒 | 二进制 | 转速、扭矩、温度等 |
| BMS状态 | 1秒 | 二进制 | 电压、电流、SOC等 |
| 充电桩状态 | 1秒 | 二进制 | 功率、电量等 |
| 告警记录 | 事件触发 | SQLite | 告警详情 |
| 统计数据 | 1小时 | SQLite | 汇总统计 |

### 5.2 二进制数据格式

#### 5.2.0 通用规则
| 规则 | 说明 |
|------|------|
| 字节序 | 小端序（Little-Endian），与ARM架构一致 |
| 对齐方式 | 自然对齐，结构体末尾填充至4字节整数倍 |
| 时间戳 | UTC毫秒时间戳（int64），避免时区歧义 |
| 日期目录 | 本地时区日期（YYYY-MM-DD），便于人工查看 |
| 文件名 | `{设备类型}.dat`，如`foc.dat`、`bms.dat` |

**版本兼容策略**：
- 版本号递增时，新字段追加到保留区域
- 读取时检查版本号，低版本忽略未知字段
- 记录大小字段用于跳过未知版本的记录

#### 5.2.1 文件头（16字节）
| 偏移 | 长度 | 类型 | 说明 |
|------|------|------|------|
| 0 | 4 | uint32 | 魔数 0x454D5344 ("EMSD") |
| 4 | 2 | uint16 | 版本号 |
| 6 | 2 | uint16 | 记录大小(字节) |
| 8 | 4 | uint32 | 记录数量 |
| 12 | 4 | uint32 | 保留 |

#### 5.2.2 FOC数据记录（32字节）
| 偏移 | 长度 | 类型 | 说明 |
|------|------|------|------|
| 0 | 8 | int64 | 时间戳(毫秒) |
| 8 | 2 | int16 | 运行状态 |
| 10 | 2 | int16 | 控制模式 |
| 12 | 4 | int32 | 实际转速(rpm) |
| 16 | 2 | int16 | 实际扭矩(0.1Nm) |
| 18 | 2 | uint16 | 母线电压(0.1V) |
| 20 | 2 | int16 | 母线电流(0.1A) |
| 22 | 2 | int16 | 电机温度(0.1°C) |
| 24 | 2 | int16 | 控制器温度(0.1°C) |
| 26 | 2 | uint16 | 故障码 |
| 28 | 4 | uint32 | 保留 |

#### 5.2.3 BMS数据记录（48字节）
| 偏移 | 长度 | 类型 | 说明 |
|------|------|------|------|
| 0 | 8 | int64 | 时间戳(毫秒) |
| 8 | 4 | int32 | 总电压(0.1V) |
| 12 | 4 | int32 | 总电流(0.1A) |
| 16 | 2 | uint16 | SOC(0.1%) |
| 18 | 2 | uint16 | SOH(0.1%) |
| 20 | 2 | uint16 | 最高单体电压(mV) |
| 22 | 2 | uint16 | 最低单体电压(mV) |
| 24 | 2 | int16 | 最高温度(0.1°C) |
| 26 | 2 | int16 | 最低温度(0.1°C) |
| 28 | 2 | uint16 | 充电状态 |
| 30 | 2 | uint16 | 放电状态 |
| 32 | 4 | uint32 | 故障标志 |
| 36 | 4 | int32 | DCL功率(0.1kW) |
| 40 | 4 | int32 | CCL功率(0.1kW) |
| 44 | 4 | uint32 | 保留 |

#### 5.2.4 充电桩数据记录（40字节）
| 偏移 | 长度 | 类型 | 说明 |
|------|------|------|------|
| 0 | 8 | int64 | 时间戳(毫秒) |
| 8 | 2 | uint16 | 状态枚举 |
| 10 | 2 | uint16 | 连接器ID |
| 12 | 4 | int32 | 电压(0.1V) |
| 16 | 4 | int32 | 电流(0.1A) |
| 20 | 4 | int32 | 功率(0.1kW) |
| 24 | 4 | uint32 | 电量(0.1kWh) |
| 28 | 2 | uint16 | SOC(%) |
| 30 | 2 | uint16 | 错误码枚举 |
| 32 | 4 | uint32 | 充电时长(秒) |
| 36 | 4 | uint32 | 保留 |

### 5.3 告警记录（SQLite）

#### 5.3.1 表结构
```sql
CREATE TABLE alarms (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    alarm_id TEXT NOT NULL UNIQUE,      -- 告警唯一标识
    source TEXT NOT NULL,               -- 告警来源: foc/bms/charger/system
    device_id TEXT NOT NULL,            -- 设备ID
    level TEXT NOT NULL,                -- 告警级别: L1/L2/L3/L4
    type TEXT NOT NULL,                 -- 告警类型
    code INTEGER NOT NULL,              -- 告警码
    message TEXT,                       -- 告警描述
    value REAL,                         -- 触发值
    threshold REAL,                     -- 阈值
    occur_time INTEGER NOT NULL,        -- 发生时间(毫秒时间戳)
    clear_time INTEGER,                 -- 清除时间(毫秒时间戳)
    acknowledged INTEGER DEFAULT 0,     -- 是否已确认: 0/1
    ack_time INTEGER,                   -- 确认时间
    ack_user TEXT                       -- 确认用户
);

CREATE INDEX idx_alarms_occur_time ON alarms(occur_time);
CREATE INDEX idx_alarms_device_id ON alarms(device_id);
CREATE INDEX idx_alarms_level ON alarms(level);
```

### 5.4 统计数据（SQLite）

#### 5.4.1 表结构
```sql
-- 小时统计表
CREATE TABLE hourly_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    device_id TEXT NOT NULL,
    stat_hour INTEGER NOT NULL,         -- 小时时间戳(整点)
    charge_energy REAL DEFAULT 0,       -- 充电电量(kWh)
    discharge_energy REAL DEFAULT 0,    -- 放电电量(kWh)
    run_time INTEGER DEFAULT 0,         -- 运行时长(秒)
    fault_count INTEGER DEFAULT 0,      -- 故障次数
    max_temp REAL,                       -- 最高温度
    min_temp REAL,                       -- 最低温度
    UNIQUE(device_id, stat_hour)
);

-- 日统计表
CREATE TABLE daily_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    device_id TEXT NOT NULL,
    stat_date TEXT NOT NULL,            -- 日期 YYYY-MM-DD
    charge_energy REAL DEFAULT 0,
    discharge_energy REAL DEFAULT 0,
    run_time INTEGER DEFAULT 0,
    fault_count INTEGER DEFAULT 0,
    alarm_count INTEGER DEFAULT 0,
    UNIQUE(device_id, stat_date)
);
```

---

## 六、数据清理策略

### 6.1 自动清理规则
| 数据类型 | 保留期限 | 清理时机 | 清理方式 |
|----------|----------|----------|----------|
| 历史数据文件 | 30天 | 每日0点 | 删除过期目录 |
| 日志文件 | 500MB | 轮转时 | 删除最旧文件 |
| 告警记录 | 90天 | 每日0点 | DELETE过期记录 |
| 统计数据 | 365天 | 每月1日 | DELETE过期记录 |

### 6.2 SQLite维护策略

#### 6.2.1 VACUUM执行规则
| 条件 | 说明 |
|------|------|
| 触发条件 | DELETE操作删除记录数 ≥ 1000条 |
| 执行时机 | 每日清理任务完成后（约0:05） |
| 执行频率 | 最多每日1次 |

#### 6.2.2 并发影响与规避
| 场景 | 影响 | 规避措施 |
|------|------|----------|
| VACUUM执行期间 | 数据库独占锁，阻塞所有读写 | 选择业务低峰期（凌晨）执行 |
| 执行时长 | 取决于数据量，通常1-10秒 | 设置超时，超时则跳过本次 |
| 磁盘空间 | 需要约等于数据库大小的临时空间 | 执行前检查可用空间 |

#### 6.2.3 维护流程
```
每日0:00清理任务：
1. 删除过期历史数据目录
2. DELETE过期告警记录，记录删除数量
3. 若删除数量 ≥ 1000，标记需要VACUUM
4. 等待5分钟（避开整点业务高峰）
5. 检查磁盘可用空间 > 数据库大小
6. 执行VACUUM（超时30秒）
7. 记录维护日志
```

### 6.3 清理流程
```
每日0点执行：
1. 扫描 /opt/ems/data/history/ 目录
2. 计算目录日期与当前日期差值
3. 删除超过30天的目录
4. 按6.2条件判断是否执行VACUUM
5. 记录清理日志
```

### 6.4 存储空间监控
| 阈值 | 动作 |
|------|------|
| 使用率 > 80% | 记录警告日志 |
| 使用率 > 90% | 触发紧急清理（保留7天） |
| 使用率 > 95% | 停止历史数据记录 |

---

## 七、数据完整性

### 7.1 写入保护
| 措施 | 说明 |
|------|------|
| 原子写入 | 配置文件先写临时文件再重命名 |
| 写入缓冲 | 历史数据批量写入，减少IO次数 |
| 掉电保护 | 关键数据使用fsync强制刷盘 |

### 7.2 数据校验
| 数据类型 | 校验方式 |
|----------|----------|
| 配置文件 | JSON格式校验 + 字段校验 |
| 历史数据 | 文件头魔数校验 |
| SQLite | 数据库完整性检查 |

### 7.3 异常恢复
| 场景 | 恢复策略 |
|------|----------|
| 配置文件损坏 | 从.bak备份恢复 |
| 历史数据损坏 | 丢弃损坏文件，记录日志 |
| SQLite损坏 | 尝试修复，失败则重建 |

---

## 八、注意事项

### 8.1 Flash寿命保护
- 避免频繁小量写入，使用缓冲批量写入
- 日志级别生产环境设为INFO，减少写入量
- 历史数据采集间隔不低于1秒

### 8.2 存储容量规划
| 数据类型 | 单日容量估算 | 30天容量 |
|----------|--------------|----------|
| FOC历史 | ~2.7MB | ~81MB |
| BMS历史 | ~4.1MB | ~123MB |
| 充电桩历史 | ~3.4MB | ~102MB |
| 日志 | ~10MB | ~300MB |
| **合计** | ~20MB | ~600MB |

### 8.3 备份建议
- 配置文件：变更时自动备份
- 历史数据：可选导出到SD卡
- 告警记录：定期导出CSV备份

---

**文档版本**: v1.0
**编制日期**: 2025-12-30
**适用范围**: EMS数据存储管理
