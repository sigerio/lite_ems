# 设备地址分配规则

## 一、概述

### 1.1 适用范围
本文档定义EMS系统中各类设备的地址分配规则，确保多设备场景下地址唯一、无冲突。

### 1.2 设备规模
| 设备类型 | 当前规模 | 最大扩展 | 协议 |
|----------|----------|----------|------|
| FOC电机控制 | 1台 | 5台 | Modbus RTU |
| BMS电池管理 | 1台 | 5台 | IEC104 |
| 充电桩 | 1台 | 5台 | OCPP 1.6 |

---

## 二、Modbus从站地址分配（FOC）

### 2.1 地址范围
| 项目 | 值 | 说明 |
|------|-----|------|
| 协议范围 | 1~247 | Modbus RTU标准 |
| 系统分配范围 | 1~5 | FOC设备专用 |
| 默认地址 | 1 | 出厂默认 |

### 2.2 分配规则
| 设备编号 | 从站地址 | 设备ID | 说明 |
|----------|----------|--------|------|
| FOC #1 | 1 | FOC001 | 默认设备 |
| FOC #2 | 2 | FOC002 | 扩展设备 |
| FOC #3 | 3 | FOC003 | 扩展设备 |
| FOC #4 | 4 | FOC004 | 扩展设备 |
| FOC #5 | 5 | FOC005 | 扩展设备 |

### 2.3 地址配置方式
- **寄存器地址**：0x0200（设备地址寄存器）
- **配置时机**：设备首次上电或手动配置
- **生效方式**：写入后需重启生效
- **持久化**：掉电保存

### 2.4 地址冲突检测

**重要说明**：Modbus RTU协议本身无法可靠检测地址冲突，以下检测仅为**尽力提示**，不能保证100%准确。

**检测流程**：
```
EMS启动时执行：
1. 遍历地址1~5，发送0x03读取请求
2. 响应设备记录为在线
3. 检测到重复响应则报告地址冲突告警（仅供参考）
```

**冲突典型表现**：
| 现象 | 可能原因 | 说明 |
|------|----------|------|
| CRC校验错误 | 多设备同时响应导致数据碰撞 | 最常见的冲突表现 |
| 响应超时 | 设备响应相互干扰 | 可能误判为设备离线 |
| 数据异常 | 多个响应帧叠加 | 读取值不符合预期 |
| 间歇性通讯失败 | 冲突概率性发生 | 难以稳定复现 |

**检测局限性**：
- 同地址设备可能恰好不同时响应，导致漏检
- CRC错误也可能由线路干扰引起，导致误报
- 无法区分"地址冲突"与"硬件故障"

**建议措施**：
1. **安装配置阶段**：逐台接入设备，确认地址唯一后再接入下一台
2. **地址规划**：严格按照2.2节分配规则，避免手动修改地址
3. **标签管理**：在设备外壳标注已分配的从站地址
4. **文档记录**：维护设备地址分配表，变更时同步更新

---

## 三、IEC104公共地址分配（BMS）

### 3.1 地址范围
| 项目 | 值 | 说明 |
|------|-----|------|
| 协议范围 | 1~65535 | IEC104标准 |
| 系统分配范围 | 1~5 | BMS设备专用 |
| 默认地址 | 1 | 出厂默认 |

### 3.2 分配规则
| 设备编号 | 公共地址(ASDU) | 设备ID | IP地址（建议） |
|----------|----------------|--------|----------------|
| BMS #1 | 1 | BMS001 | 192.168.1.101 |
| BMS #2 | 2 | BMS002 | 192.168.1.102 |
| BMS #3 | 3 | BMS003 | 192.168.1.103 |
| BMS #4 | 4 | BMS004 | 192.168.1.104 |
| BMS #5 | 5 | BMS005 | 192.168.1.105 |

### 3.3 网络配置
| 参数 | 值 | 说明 |
|------|-----|------|
| TCP端口 | 2404 | IEC104标准端口 |
| EMS IP | 192.168.1.100 | 控制站地址 |
| 子网掩码 | 255.255.255.0 | /24网段 |

### 3.4 IOA地址空间
各BMS设备共享相同的IOA定义（见02_BMS-DTU通讯协议），通过公共地址区分设备。

---

## 四、OCPP充电桩标识分配

### 4.1 标识规则
| 项目 | 格式 | 示例 |
|------|------|------|
| chargePointId | CP + 3位序号 | CP001 |
| chargePointSerialNumber | SN + 年月 + 3位序号 | SN202401001 |
| chargeBoxSerialNumber | BOX + 年月 + 3位序号 | BOX202401001 |

### 4.2 分配规则
| 设备编号 | chargePointId | 设备ID | WebSocket端点 |
|----------|---------------|--------|---------------|
| 充电桩 #1 | CP001 | CP001 | ws://ems:8080/ocpp/CP001 |
| 充电桩 #2 | CP002 | CP002 | ws://ems:8080/ocpp/CP002 |
| 充电桩 #3 | CP003 | CP003 | ws://ems:8080/ocpp/CP003 |
| 充电桩 #4 | CP004 | CP004 | ws://ems:8080/ocpp/CP004 |
| 充电桩 #5 | CP005 | CP005 | ws://ems:8080/ocpp/CP005 |

### 4.3 连接器编号
| 参数 | 值 | 说明 |
|------|-----|------|
| connectorId | 0 | 充电桩整体（用于配置） |
| connectorId | 1~N | 物理连接器（当前为1） |

### 4.4 网络配置
| 参数 | 值 | 说明 |
|------|-----|------|
| EMS WebSocket端口 | 8080 | OCPP服务端口 |
| 心跳间隔 | 300秒 | BootNotification返回 |

---

## 五、统一设备ID规范

### 5.1 设备ID格式
```
格式：<设备类型前缀><3位序号>
示例：FOC001, BMS001, CP001
```

### 5.2 设备类型前缀
| 前缀 | 设备类型 | 说明 |
|------|----------|------|
| FOC | FOC电机控制 | Field Oriented Control |
| BMS | 电池管理系统 | Battery Management System |
| CP | 充电桩 | Charge Point |

### 5.3 设备ID与协议地址映射
| 设备ID | Modbus地址 | IEC104地址 | OCPP标识 |
|--------|------------|------------|----------|
| FOC001 | 1 | - | - |
| FOC002 | 2 | - | - |
| BMS001 | - | 1 | - |
| BMS002 | - | 2 | - |
| CP001 | - | - | CP001 |
| CP002 | - | - | CP002 |

---

## 六、设备注册与发现机制

### 6.1 FOC设备发现（Modbus轮询）
```
启动流程：
1. EMS启动后，按配置的地址列表轮询
2. 对每个地址发送0x03读取设备信息寄存器(0x0215-0x021A)
3. 响应成功则标记设备在线，记录版本信息
4. 无响应则标记设备离线

周期检测：
- 正常轮询周期内无响应3次，标记设备离线
- 设备恢复响应后自动标记在线
```

### 6.2 BMS设备发现（IEC104连接）
```
启动流程：
1. EMS按配置的IP地址列表尝试TCP连接
2. 连接成功后发送STARTDT激活
3. 发送总召唤获取设备信息
4. 记录设备在线状态

断线检测：
- 心跳超时(t3=20s)后标记设备离线
- 自动重连机制(间隔10s)
```

### 6.3 充电桩设备发现（OCPP注册）
```
启动流程：
1. EMS启动OCPP WebSocket服务(端口8080)
2. 充电桩主动连接并发送BootNotification
3. EMS验证chargePointId，返回Accepted/Rejected
4. 记录设备在线状态

断线检测：
- 心跳超时(interval×2)后标记设备离线
- 充电桩断线后自动重连
```

### 6.4 设备状态表
| 状态 | 值 | 说明 |
|------|-----|------|
| offline | 0 | 设备离线 |
| online | 1 | 设备在线 |
| fault | 2 | 设备故障 |
| unknown | 3 | 状态未知（启动中） |

---

## 七、地址配置文件

### 7.1 配置文件路径
```
/etc/ems/devices.json
```

### 7.2 配置文件格式
```json
{
  "foc_devices": [
    {"device_id": "FOC001", "modbus_addr": 1, "enabled": true},
    {"device_id": "FOC002", "modbus_addr": 2, "enabled": false}
  ],
  "bms_devices": [
    {"device_id": "BMS001", "asdu_addr": 1, "ip": "192.168.1.101", "port": 2404, "enabled": true}
  ],
  "charger_devices": [
    {"device_id": "CP001", "charge_point_id": "CP001", "enabled": true}
  ]
}
```

### 7.3 配置项说明
| 字段 | 类型 | 说明 |
|------|------|------|
| device_id | string | 统一设备ID |
| modbus_addr | number | Modbus从站地址(FOC) |
| asdu_addr | number | IEC104公共地址(BMS) |
| ip | string | 设备IP地址(BMS) |
| port | number | TCP端口(BMS) |
| charge_point_id | string | OCPP充电桩标识 |
| enabled | boolean | 是否启用 |

---

## 八、注意事项

### 8.1 地址唯一性
- 同类型设备地址不得重复
- 修改地址前需确认无冲突
- 地址变更后需重启相关服务

### 8.2 扩展设备
- 新增设备前需在配置文件中添加条目
- 设备ID按序号递增分配
- 超过5台设备需评估系统容量

### 8.3 故障处理
- 地址冲突：检查设备配置，修改冲突地址
- 设备离线：检查物理连接和网络配置
- 注册失败：检查设备ID和认证配置

---

**文档版本**: v1.0
**编制日期**: 2025-12-30
**适用范围**: EMS设备地址管理
