================================================================================
                        EMS能源管理系统 - EMS主控模块
================================================================================

一、功能概述
--------------------------------------------------------------------------------
EMS主控系统是整个能源管理系统的核心调度单元，负责协调各子系统的工作，
实现能源的高效分配和安全管控。


二、信息收集处理
--------------------------------------------------------------------------------

2.1 充电桩信息采集
- 充电信息：电压、电流、功率、启停时间
- 电池信息：充电电池温度、电池SOC/SOH
- 告警信息：电池告警、充电桩告警
- 控制功能：手动启停、功率限制、OTA

2.2 BMS管理信息采集
- 电池信息：电池电压、单片电压、各电池温度、SOC/SOH、告警信息
- 充电状态：充电功率、充电电流、充电电压
- 放电状态：放电功率、放电电压、放电电流
- 控制功能：充放电功率限制

2.3 电机驱动板信息采集
- 电机信息：电机转速、电机状态
- 工作信息：工作电流、工作电压、三环控制信息


三、充放电仲裁
--------------------------------------------------------------------------------

3.1 仲裁策略
- 优先级管理：根据任务紧急程度分配功率
- 功率分配：根据各设备需求和电网容量分配
- 负载均衡：避免单一设备过载
- 峰谷调度：利用电价峰谷差优化充电时间

3.2 仲裁流程
1. 采集各设备功率需求
2. 计算总可用功率（电网容量-其他负载）
3. 根据优先级分配功率
4. 下发功率限制指令
5. 持续监控并动态调整


四、设备过热处理
--------------------------------------------------------------------------------

4.1 温度监控
- 监控对象：充电桩、BMS、FOC、电池组
- 采集周期：实时/秒级

4.2 保护策略
- 预警阈值:温度接近上限时预警
- 降功率运行:温度过高时降低功率
- 停机保护:温度超限时停止运行
- 冷却控制:联动风扇/液冷系统


五、故障处理机制
--------------------------------------------------------------------------------

5.1 故障等级定义

L1 - 警告(Warning):
  - 影响范围:不影响正常运行
  - 处理方式:记录日志,提示用户
  - 恢复方式:自动恢复
  - 典型故障:温度接近阈值、通讯偶发延迟、电压波动

L2 - 告警(Alarm):
  - 影响范围:性能下降,需关注
  - 处理方式:降级运行,上报告警
  - 恢复方式:故障消失后自动恢复
  - 典型故障:单体压差偏大、温度偏高、SOC偏低

L3 - 故障(Fault):
  - 影响范围:功能受限,需降级保护
  - 处理方式:限功率运行或停止部分功能
  - 恢复方式:需确认故障消失+手动复位
  - 典型故障:过流、过温、编码器异常

L4 - 严重故障(Critical):
  - 影响范围:安全风险,立即停机
  - 处理方式:紧急停机,断开高压
  - 恢复方式:需人工检查+手动复位+设备自检
  - 典型故障:绝缘故障、短路、单体过压、通讯中断

5.2 故障处理流程

【故障检测阶段】
1. 各子系统实时自检
2. 检测到异常 → 判断故障等级
3. 上报EMS主控(故障码+等级+时间戳)

【EMS决策阶段】
4. 接收故障信息
5. 查询故障优先级矩阵
6. 评估影响范围和联动设备
7. 制定处理策略(继续/降级/停机)

【执行保护阶段】
8. 下发控制指令至各子系统
9. 各子系统执行保护动作
10. 确认保护动作完成

【记录与监控阶段】
11. 记录故障日志(时间/类型/等级/处理)
12. 持续监控故障状态
13. 等待故障恢复条件满足

【故障恢复阶段】
14. 检测到故障消失
15. L1/L2自动恢复,L3/L4需手动复位
16. 执行恢复流程
17. 恢复正常运行

5.3 故障优先级矩阵

【BMS故障及联动】
┌──────────────┬─────┬────┬──────────────────┬─────────────┬─────────────┬─────────────┐
│ 故障类型     │ 来源│等级│ EMS处理策略      │ FOC响应     │ 充电桩响应  │ BMS自身响应 │
├──────────────┼─────┼────┼──────────────────┼─────────────┼─────────────┼─────────────┤
│单体过压      │ BMS │ L4 │立即停止充电      │继续运行     │停止充电     │断开继电器   │
│单体欠压      │ BMS │ L4 │立即停止放电      │停止电机     │继续运行     │断开继电器   │
│总压过压      │ BMS │ L4 │停止充电          │继续运行     │停止充电     │断开继电器   │
│总压欠压      │ BMS │ L3 │停止放电          │降功率运行   │继续运行     │限制放电电流 │
│充电过流      │ BMS │ L3 │降低充电功率50%   │继续运行     │降功率运行   │限制充电电流 │
│放电过流      │ BMS │ L3 │降低电机功率30%   │降功率运行   │继续运行     │限制放电电流 │
│短路          │ BMS │ L4 │紧急停机          │紧急停机     │停止充电     │断开所有继电器│
│充电高温      │ BMS │ L3 │降低充电功率30%   │继续运行     │降功率运行   │限制充电电流 │
│充电低温      │ BMS │ L3 │禁止充电          │继续运行     │停止充电     │禁止充电     │
│放电高温      │ BMS │ L3 │降低电机功率50%   │降功率运行   │继续运行     │限制放电电流 │
│放电低温      │ BMS │ L2 │限制放电功率70%   │限功率运行   │继续运行     │限制放电电流 │
│单体压差过大  │ BMS │ L2 │启动均衡          │继续运行     │继续运行     │启动均衡     │
│温差过大      │ BMS │ L2 │降低充放电功率20% │继续运行     │继续运行     │启动冷却     │
│绝缘故障      │ BMS │ L4 │断开高压,停止所有 │紧急停机     │断开输出     │断开继电器   │
│SOC过低       │ BMS │ L2 │禁止放电,允许充电 │停止电机     │允许充电     │禁止放电     │
│SOC过高       │ BMS │ L2 │禁止充电,允许放电 │允许运行     │禁止充电     │禁止充电     │
│SOH过低       │ BMS │ L1 │提示更换电池      │继续运行     │继续运行     │记录日志     │
│均衡故障      │ BMS │ L2 │停止均衡          │继续运行     │继续运行     │停止均衡     │
│继电器故障    │ BMS │ L4 │禁止充放电        │停止电机     │停止充电     │停止继电器操作│
│预充超时      │ BMS │ L4 │停止上电流程      │禁止运行     │禁止充电     │断开继电器   │
│BMS通讯中断   │ EMS │ L4 │停止所有充放电    │紧急停机     │停止充电     │-            │
└──────────────┴─────┴────┴──────────────────┴─────────────┴─────────────┴─────────────┘

【充电桩故障及联动】
┌──────────────┬─────┬────┬──────────────────┬─────────────┬─────────────┬─────────────┐
│ 故障类型     │ 来源│等级│ EMS处理策略      │ FOC响应     │ 充电桩自身  │ BMS响应     │
├──────────────┼─────┼────┼──────────────────┼─────────────┼─────────────┼─────────────┤
│绝缘故障      │充电桩│ L4 │断开高压,停止充电 │紧急停机     │断开输出     │断开继电器   │
│过压故障      │充电桩│ L4 │停止充电          │继续运行     │停止输出     │断开继电器   │
│过流故障      │充电桩│ L3 │降低充电功率40%   │继续运行     │降功率运行   │限制充电电流 │
│过温故障      │充电桩│ L3 │降低充电功率30%   │继续运行     │降功率+散热  │限制充电电流 │
│与BMS通讯中断 │充电桩│ L4 │停止充电          │继续运行     │停止输出     │继续监控     │
│急停按下      │充电桩│ L4 │停止充电          │紧急停机     │停止输出     │断开继电器   │
│电子锁故障    │充电桩│ L3 │禁止拔枪,继续充电 │继续运行     │保持锁定     │继续运行     │
│电表故障      │充电桩│ L2 │允许继续,无计量   │继续运行     │继续运行     │继续运行     │
│充电桩通讯中断│ EMS │ L4 │停止充电          │继续运行     │-            │断开继电器   │
└──────────────┴─────┴────┴──────────────────┴─────────────┴─────────────┴─────────────┘

【FOC故障及联动】
┌──────────────┬─────┬────┬──────────────────┬─────────────┬─────────────┬─────────────┐
│ 故障类型     │ 来源│等级│ EMS处理策略      │ FOC自身响应 │ 充电桩响应  │ BMS响应     │
├──────────────┼─────┼────┼──────────────────┼─────────────┼─────────────┼─────────────┤
│过流故障      │ FOC │ L4 │紧急停机          │紧急停机     │继续运行     │允许充电     │
│过压故障      │ FOC │ L4 │紧急停机          │紧急停机     │继续运行     │允许充电     │
│欠压故障      │ FOC │ L3 │降低电机功率50%   │降功率运行   │允许充电     │允许充电     │
│电机过温      │ FOC │ L3 │降低电机功率30%   │降功率+散热  │继续运行     │继续运行     │
│控制器过温    │ FOC │ L3 │降低电机功率40%   │降功率+散热  │继续运行     │继续运行     │
│编码器故障    │ FOC │ L4 │停止电机          │切无感模式   │继续运行     │继续运行     │
│堵转故障      │ FOC │ L4 │停止电机          │紧急停机     │继续运行     │继续运行     │
│速度超限      │ FOC │ L3 │限制目标转速      │限速运行     │继续运行     │继续运行     │
│IGBT故障      │ FOC │ L4 │紧急停机          │紧急停机     │继续运行     │允许充电     │
│FOC通讯中断   │ EMS │ L4 │停止电机          │-            │继续运行     │继续运行     │
└──────────────┴─────┴────┴──────────────────┴─────────────┴─────────────┴─────────────┘

【EMS自身故障】
┌──────────────┬─────┬────┬──────────────────┬─────────────┬─────────────┬─────────────┐
│ 故障类型     │ 来源│等级│ EMS处理策略      │ FOC响应     │ 充电桩响应  │ BMS响应     │
├──────────────┼─────┼────┼──────────────────┼─────────────┼─────────────┼─────────────┤
│看门狗复位    │ EMS │ L4 │重启EMS           │保持状态     │保持状态     │保持状态     │
│存储器故障    │ EMS │ L4 │停止所有任务      │紧急停机     │停止充电     │断开继电器   │
│时钟故障      │ EMS │ L2 │记录告警,继续运行 │继续运行     │继续运行     │继续运行     │
│多设备通讯中断│ EMS │ L4 │紧急停机          │紧急停机     │停止充电     │断开继电器   │
└──────────────┴─────┴────┴──────────────────┴─────────────┴─────────────┴─────────────┘

5.4 故障恢复条件

【L1警告恢复】
- 自动恢复:故障消失即自动恢复
- 无需复位操作
- 无需人工确认

【L2告警恢复】
- 自动恢复:故障消失超过30秒自动恢复
- 恢复过程:逐步提升功率至正常值
- 记录恢复日志

【L3故障恢复】
- 手动复位:需确认故障已消失
- 复位方式:终端/EMS发送复位指令
- 恢复流程:
  1. 确认故障已消失
  2. 操作人员发送故障复位指令
  3. EMS检查相关设备状态
  4. 清除故障标志
  5. 允许重新启动

【L4严重故障恢复】
- 人工检查:需现场人员检查设备
- 自检测试:设备需通过自检
- 手动复位:管理员权限操作
- 恢复流程:
  1. 现场人员检查故障原因
  2. 排除故障隐患
  3. 设备执行完整自检
  4. 管理员确认并复位
  5. EMS重新初始化相关设备
  6. 逐步恢复至正常运行

5.5 故障记录与统计

【故障记录内容】
- 时间戳:故障发生/恢复时间
- 故障源:哪个设备/模块
- 故障码:具体故障类型
- 等级:L1/L2/L3/L4
- 处理策略:EMS采取的措施
- 联动响应:其他设备的响应
- 恢复方式:自动/手动
- 持续时间:故障持续时长

【故障统计分析】
- 故障频次统计(按类型/设备/时段)
- 故障时长统计
- 故障恢复成功率
- 高频故障预警


六、上下电时序
--------------------------------------------------------------------------------

6.1 上电流程
1. 检测外部供电状态
2. EMS主控自检
3. 依次唤醒下级设备(FOC→BMS→充电桩)
4. 各设备自检并上报状态
5. 系统就绪

6.2 下电流程
1. 接收关机指令
2. 停止所有充放电任务
3. 断开高压继电器
4. 保存运行数据
5. 依次关闭下级设备
6. EMS主控进入休眠


七、终端交互
--------------------------------------------------------------------------------

7.1 交互功能
- 状态同步:实时推送系统状态至终端
- 指令接收:接收终端下发的控制指令
- 参数配置:支持远程参数修改
- 告警推送:异常事件即时通知

7.2 数据格式
- 通讯协议:WiFi
- 数据格式:JSON
- 心跳机制:定时上报存活状态


八、OTA升级管理
--------------------------------------------------------------------------------

8.1 升级功能
- 版本管理:管理各设备固件版本
- 升级下发:向下级设备推送固件
- 进度监控:监控升级进度
- 回滚机制:升级失败时回滚

8.2 升级流程
1. 接收升级包(从终端/云端)
2. 校验升级包完整性
3. 通知目标设备准备升级
4. 分片传输固件
5. 设备执行升级
6. 验证升级结果


================================================================================
文档版本：v1.0
================================================================================
