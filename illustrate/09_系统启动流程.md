# 系统启动流程

## 一、概述

### 1.1 适用范围
本文档定义EMS系统的完整启动流程，包括主控启动时序、设备初始化顺序、通讯链路建立和系统就绪判定。

### 1.2 启动目标
| 目标 | 说明 |
|------|------|
| 安全性 | 确保各设备按正确顺序上电，避免冲突 |
| 可靠性 | 检测并处理启动过程中的异常 |
| 可观测性 | 提供启动状态反馈，便于排障 |

---

## 二、EMS主控启动时序

### 2.1 启动阶段概览
```
┌─────────────────────────────────────────────────────────────────┐
│                        EMS启动时序                               │
├─────────┬─────────┬─────────┬─────────┬─────────┬─────────────┤
│ 阶段1   │ 阶段2   │ 阶段3   │ 阶段4   │ 阶段5   │ 阶段6       │
│ 硬件    │ 系统    │ 配置    │ 设备    │ 通讯    │ 就绪        │
│ 自检    │ 初始化  │ 加载    │ 初始化  │ 建立    │ 判定        │
├─────────┼─────────┼─────────┼─────────┼─────────┼─────────────┤
│ ~1s     │ ~2s     │ ~1s     │ ~5s     │ ~10s    │ ~1s         │
└─────────┴─────────┴─────────┴─────────┴─────────┴─────────────┘
                        总计约20秒
```

### 2.2 阶段1：硬件自检（约1秒）
| 步骤 | 检查项 | 失败处理 |
|------|--------|----------|
| 1.1 | CPU/内存自检 | 系统无法启动 |
| 1.2 | 存储介质检测 | 记录错误，尝试只读模式 |
| 1.3 | 串口设备检测 | 记录警告，对应设备不可用 |
| 1.4 | 网络接口检测 | 记录警告，网络功能受限 |
| 1.5 | RTC时钟检测 | 使用默认时间，记录警告 |

### 2.3 阶段2：系统初始化（约2秒）
| 步骤 | 操作 | 说明 |
|------|------|------|
| 2.1 | 初始化日志系统 | 打开日志文件，设置级别 |
| 2.2 | 初始化信号处理 | 注册SIGTERM/SIGINT处理 |
| 2.3 | 创建工作目录 | 确保data/log/tmp目录存在 |
| 2.4 | 初始化定时器 | 创建定时任务调度器 |
| 2.5 | 初始化事件循环 | 创建主事件循环 |

### 2.4 阶段3：配置加载（约1秒）
| 步骤 | 操作 | 失败处理 |
|------|------|----------|
| 3.1 | 加载system.json | 使用默认配置 |
| 3.2 | 加载devices.json | 使用默认配置 |
| 3.3 | 加载network.json | 使用默认配置 |
| 3.4 | 校验配置完整性 | 记录警告，使用默认值补全 |
| 3.5 | 应用日志级别配置 | - |

**配置加载失败策略**：
- 配置文件不存在：创建默认配置文件
- 配置文件损坏：尝试从.bak恢复，失败则使用默认配置
- 字段缺失：使用默认值补全，记录警告

### 2.5 阶段4：设备初始化（约5秒）
详见第三章"设备初始化顺序"。

### 2.6 阶段5：通讯建立（约10秒）
详见第四章"通讯链路建立流程"。

### 2.7 阶段6：就绪判定（约1秒）
详见第五章"系统就绪判定条件"。

---

## 三、设备初始化顺序

### 3.1 初始化顺序
```
┌─────────────────────────────────────────────────────────────┐
│                     设备初始化顺序                           │
│                                                             │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐               │
│   │  FOC    │ -> │  BMS    │ -> │ 充电桩  │               │
│   │ Modbus  │    │ IEC104  │    │  OCPP   │               │
│   └─────────┘    └─────────┘    └─────────┘               │
│      ~2s            ~2s            ~1s                      │
│                                                             │
│   说明：FOC优先（电机安全）-> BMS（电池状态）-> 充电桩      │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 FOC设备初始化（约2秒）
| 步骤 | 操作 | 超时 | 失败处理 |
|------|------|------|----------|
| 1 | 打开串口(/dev/ttyS3) | 1s | 标记设备不可用 |
| 2 | 配置串口参数(115200,8N1) | - | 标记设备不可用 |
| 3 | 遍历配置的FOC地址(1-5) | - | - |
| 4 | 发送读取设备信息请求(0x03) | 500ms | 标记该地址离线 |
| 5 | 记录在线设备列表 | - | - |

**FOC初始化伪代码**：
```
for each foc in config.foc_devices:
    if not foc.enabled:
        continue
    send_modbus_read(foc.modbus_addr, 0x0215, 6)  // 读取设备信息
    if response_ok:
        foc.status = ONLINE
        log_info("FOC %s 在线", foc.device_id)
    else:
        foc.status = OFFLINE
        log_warn("FOC %s 离线", foc.device_id)
```

### 3.3 BMS设备初始化（约2秒）
| 步骤 | 操作 | 超时 | 失败处理 |
|------|------|------|----------|
| 1 | 遍历配置的BMS设备 | - | - |
| 2 | 建立TCP连接 | 2s | 标记设备离线 |
| 3 | 发送STARTDT激活 | 1s | 断开连接，标记离线 |
| 4 | 等待STARTDT确认 | 1s | 断开连接，标记离线 |
| 5 | 记录在线设备列表 | - | - |

**BMS初始化伪代码**：
```
for each bms in config.bms_devices:
    if not bms.enabled:
        continue
    sock = tcp_connect(bms.ip, bms.port, timeout=2s)
    if sock == NULL:
        bms.status = OFFLINE
        log_warn("BMS %s 连接失败", bms.device_id)
        continue
    send_startdt(sock)
    if wait_startdt_confirm(sock, timeout=1s):
        bms.status = ONLINE
        log_info("BMS %s 在线", bms.device_id)
    else:
        close(sock)
        bms.status = OFFLINE
        log_warn("BMS %s 激活失败", bms.device_id)
```

### 3.4 充电桩初始化（约1秒）
| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | 启动OCPP WebSocket服务 | 监听端口8080 |
| 2 | 初始化充电桩状态表 | 所有配置的充电桩标记为OFFLINE |
| 3 | 等待充电桩主动连接 | 充电桩上电后主动连接EMS |

> **说明**：充电桩采用被动模式，EMS作为OCPP服务端等待充电桩连接，无需主动初始化。

### 3.5 初始化失败处理
| 场景 | 处理策略 |
|------|----------|
| 单个设备初始化失败 | 标记该设备离线，继续初始化其他设备 |
| 所有FOC设备离线 | 记录告警，系统可启动但电机功能不可用 |
| 所有BMS设备离线 | 记录告警，系统可启动但电池功能不可用 |
| 串口打开失败 | 记录错误，对应协议所有设备不可用 |

---

## 四、通讯链路建立流程

### 4.1 通讯链路概览
```
┌─────────────────────────────────────────────────────────────┐
│                      通讯链路建立                            │
│                                                             │
│  ┌──────────┐                           ┌──────────┐       │
│  │ 终端服务 │  TCP:9000                 │ OCPP服务 │       │
│  │ (被动)   │  等待终端连接             │ (被动)   │       │
│  └──────────┘                           └──────────┘       │
│       ↑                                      ↑             │
│       │                                      │             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐   │             │
│  │ Modbus   │  │ IEC104   │  │ 充电桩   │───┘             │
│  │ (主动)   │  │ (主动)   │  │ (被动)   │                 │
│  └──────────┘  └──────────┘  └──────────┘                 │
│       ↓              ↓                                     │
│    FOC设备       BMS设备                                   │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 终端通讯服务启动
| 步骤 | 操作 | 失败处理 |
|------|------|----------|
| 1 | 创建TCP监听socket | 记录错误，终端功能不可用 |
| 2 | 绑定端口9000 | 端口占用则记录错误 |
| 3 | 开始监听(backlog=5) | - |
| 4 | 启动accept线程 | - |

### 4.3 OCPP服务启动
| 步骤 | 操作 | 失败处理 |
|------|------|----------|
| 1 | 创建WebSocket服务 | 记录错误，充电桩功能不可用 |
| 2 | 绑定端口8080 | 端口占用则记录错误 |
| 3 | 开始监听 | - |
| 4 | 启动连接处理线程 | - |

### 4.4 Modbus轮询启动
| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | 创建轮询定时器 | 周期100ms |
| 2 | 启动轮询线程 | 按地址顺序轮询在线FOC |
| 3 | 开始数据采集 | 读取状态寄存器 |

### 4.5 IEC104连接维护
| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | 启动心跳定时器 | 周期t1=15s |
| 2 | 启动重连定时器 | 离线设备每10s尝试重连 |
| 3 | 发送总召唤 | 获取BMS初始状态 |

### 4.6 链路建立超时
| 链路类型 | 超时时间 | 超时处理 |
|----------|----------|----------|
| 终端TCP监听 | 无超时 | 持续等待 |
| OCPP监听 | 无超时 | 持续等待 |
| BMS TCP连接 | 2s | 标记离线，定时重连 |
| BMS STARTDT | 1s | 断开连接，定时重连 |

---

## 五、系统就绪判定条件

### 5.1 就绪条件
| 条件 | 必须 | 说明 |
|------|------|------|
| 配置加载成功 | 是 | 至少使用默认配置 |
| 日志系统正常 | 是 | 可写入日志 |
| 终端服务监听 | 是 | 端口9000可用 |
| 至少一个设备在线 | 否 | 无设备时记录警告 |
| 存储空间充足 | 是 | 可用空间>100MB |

### 5.2 就绪状态定义
| 状态 | 值 | 说明 |
|------|-----|------|
| STARTING | 0 | 启动中 |
| READY | 1 | 就绪，正常运行 |
| DEGRADED | 2 | 降级运行（部分功能不可用） |
| ERROR | 3 | 错误，无法正常运行 |

### 5.3 就绪判定流程
```
就绪判定流程：
1. 检查必要条件
   - 配置加载？ → 否 → ERROR
   - 日志系统？ → 否 → ERROR
   - 终端服务？ → 否 → ERROR
   - 存储空间？ → 否 → ERROR

2. 检查设备状态
   - 统计在线设备数量
   - 无设备在线 → DEGRADED + 警告
   - 有设备在线 → 继续

3. 检查通讯状态
   - OCPP服务正常？ → 否 → DEGRADED
   - Modbus正常？ → 否 → DEGRADED

4. 最终判定
   - 所有检查通过 → READY
   - 存在降级项 → DEGRADED
```

### 5.4 就绪通知
| 事件 | 动作 |
|------|------|
| 进入READY状态 | 记录INFO日志，允许终端连接 |
| 进入DEGRADED状态 | 记录WARN日志，列出降级原因 |
| 进入ERROR状态 | 记录ERROR日志，拒绝终端连接 |

### 5.5 启动完成标志
```
启动完成后：
1. 记录启动耗时
2. 记录设备在线状态汇总
3. 设置系统状态为READY/DEGRADED
4. 开始接受终端连接
5. 开始周期性数据采集
```

---

## 六、关机流程

### 6.1 正常关机时序
```
┌─────────────────────────────────────────────────────────────┐
│                      正常关机时序                            │
├─────────┬─────────┬─────────┬─────────┬─────────────────────┤
│ 阶段1   │ 阶段2   │ 阶段3   │ 阶段4   │ 阶段5               │
│ 停止    │ 断开    │ 保存    │ 关闭    │ 退出                │
│ 业务    │ 设备    │ 数据    │ 服务    │                     │
├─────────┼─────────┼─────────┼─────────┼─────────────────────┤
│ ~2s     │ ~3s     │ ~1s     │ ~1s     │ ~1s                 │
└─────────┴─────────┴─────────┴─────────┴─────────────────────┘
                        总计约8秒
```

### 6.2 关机步骤
| 阶段 | 步骤 | 操作 | 超时 |
|------|------|------|------|
| 1 | 1.1 | 停止接受新的终端连接 | - |
| 1 | 1.2 | 停止所有充放电任务 | 2s |
| 1 | 1.3 | 通知终端系统即将关闭 | - |
| 2 | 2.1 | 停止FOC电机 | 1s |
| 2 | 2.2 | 断开BMS连接(发送STOPDT) | 1s |
| 2 | 2.3 | 断开充电桩连接 | 1s |
| 3 | 3.1 | 刷新历史数据缓冲 | 500ms |
| 3 | 3.2 | 关闭SQLite数据库 | 500ms |
| 4 | 4.1 | 关闭终端TCP服务 | 500ms |
| 4 | 4.2 | 关闭OCPP服务 | 500ms |
| 5 | 5.1 | 关闭日志系统 | - |
| 5 | 5.2 | 退出主进程 | - |

### 6.3 异常关机处理
| 场景 | 处理 |
|------|------|
| 收到SIGTERM | 执行正常关机流程 |
| 收到SIGKILL | 立即终止，无清理 |
| 关机超时(30s) | 强制退出 |
| 设备断开失败 | 记录警告，继续关机 |

---

## 七、启动日志示例

### 7.1 正常启动日志
```
[2025-12-30 10:00:00.000] [INFO] [MAIN] EMS启动中，版本1.0.0
[2025-12-30 10:00:00.100] [INFO] [MAIN] 硬件自检通过
[2025-12-30 10:00:00.500] [INFO] [MAIN] 系统初始化完成
[2025-12-30 10:00:01.000] [INFO] [CONFIG] 加载配置文件成功
[2025-12-30 10:00:01.100] [INFO] [FOC] 初始化FOC设备...
[2025-12-30 10:00:02.000] [INFO] [FOC] FOC001 在线
[2025-12-30 10:00:02.100] [INFO] [BMS] 初始化BMS设备...
[2025-12-30 10:00:03.500] [INFO] [BMS] BMS001 在线
[2025-12-30 10:00:03.600] [INFO] [CHARGER] 启动OCPP服务，端口8080
[2025-12-30 10:00:03.700] [INFO] [COMM] 启动终端服务，端口9000
[2025-12-30 10:00:03.800] [INFO] [MAIN] 系统就绪，启动耗时3.8秒
[2025-12-30 10:00:03.800] [INFO] [MAIN] 在线设备: FOC=1, BMS=1, 充电桩=0
```

### 7.2 降级启动日志
```
[2025-12-30 10:00:00.000] [INFO] [MAIN] EMS启动中，版本1.0.0
[2025-12-30 10:00:01.000] [INFO] [CONFIG] 加载配置文件成功
[2025-12-30 10:00:02.000] [WARN] [FOC] FOC001 离线，通讯超时
[2025-12-30 10:00:03.500] [INFO] [BMS] BMS001 在线
[2025-12-30 10:00:03.800] [WARN] [MAIN] 系统降级运行，FOC功能不可用
[2025-12-30 10:00:03.800] [INFO] [MAIN] 在线设备: FOC=0, BMS=1, 充电桩=0
```

---

## 八、注意事项

### 8.1 启动顺序依赖
- FOC必须在BMS之前初始化（电机安全优先）
- 通讯服务必须在设备初始化之后启动
- 就绪判定必须在所有初始化完成后执行

### 8.2 超时设置
| 操作 | 超时 | 说明 |
|------|------|------|
| 总启动超时 | 60s | 超时则记录错误，强制进入DEGRADED |
| 单设备初始化 | 5s | 超时则标记离线 |
| 配置加载 | 5s | 超时则使用默认配置 |

### 8.3 重启策略
| 场景 | 策略 |
|------|------|
| 配置变更需重启 | 通过终端发送重启指令 |
| 异常崩溃 | 由systemd自动重启 |
| 手动重启 | systemctl restart ems |

---

**文档版本**: v1.0
**编制日期**: 2025-12-30
**适用范围**: EMS系统启动管理
