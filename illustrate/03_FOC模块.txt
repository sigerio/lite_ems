================================================================================
                        EMS能源管理系统 - FOC电机控制模块
================================================================================

一、功能概述
--------------------------------------------------------------------------------
FOC（Field Oriented Control，磁场定向控制）负责电机的精确控制，
将EMS的能源需求转换为电机的机械输出。


二、三环控制
--------------------------------------------------------------------------------

2.1 电流环（内环）
- 功能：控制电机相电流，实现快速响应
- 输入：电流给定值（来自速度环）
- 输出：PWM占空比
- 响应速度：最快，带宽通常1-5kHz

2.2 速度环（中环）
- 功能：控制电机转速
- 输入：速度给定值（来自位置环或上层指令）
- 输出：电流给定值
- 响应速度：中等，带宽通常10-100Hz

2.3 位置环（外环）
- 功能：控制电机角度/位置
- 输入：位置给定值（来自EMS）
- 输出：速度给定值
- 响应速度：最慢，带宽通常1-10Hz


三、电机控制功能
--------------------------------------------------------------------------------

3.1 运行模式
- 速度模式：按设定转速运行
- 扭矩模式：按设定扭矩运行
- 位置模式：按设定位置运行

3.2 控制参数
- 目标转速 (rpm)
- 目标扭矩 (Nm)
- 加减速时间
- 转矩限制

3.3 电机状态估算
- 转子位置估算（霍尔/编码器/无感）
- 转速估算
- 扭矩估算


四、能源需求管理
--------------------------------------------------------------------------------

4.1 功率需求
- 需求电流：驱动电机所需直流电流
- 需求电压：最低工作电压
- 峰值功率：加速/重载时的瞬时功率
- 持续功率：稳态运行功率

4.2 再生制动
- 制动能量回收
- 回馈电压限制
- 回馈电流限制


五、数据上报
--------------------------------------------------------------------------------

5.1 状态信息
- 电机运行状态（停止/运行/故障）
- 实际转速
- 实际扭矩
- 工作电流/电压
- 电机温度/控制器温度

5.2 故障类型
- 过流故障
- 过压/欠压故障
- 过温故障（电机/控制器）
- 编码器故障
- 通讯故障
- 堵转故障

5.3 故障处理
- 故障码上报
- 保护性停机
- 故障记录


六、与EMS通讯协议 (Modbus RTU)
--------------------------------------------------------------------------------

6.1 通讯参数
- 波特率：115200bps（可配置）
- 数据位：8位
- 停止位：1位
- 校验：无校验/CRC16

6.2 通讯模式
- EMS为主站，FOC为从站
- 轮询周期：10-50ms

6.3 功能码
- 0x03：读保持寄存器（状态读取）
- 0x06：写单个寄存器（参数设置）
- 0x10：写多个寄存器（批量配置）

6.4 寄存器地址规划
- 0x0000-0x00FF：状态寄存器（只读）
- 0x0100-0x01FF：控制寄存器（读写）
- 0x0200-0x02FF：参数寄存器（读写）
- 0x0300-0x03FF：故障寄存器（只读）

6.5 上报寄存器
- 运行状态
- 实际转速/扭矩
- 电流/电压
- 温度
- 故障码

6.6 控制寄存器
- 运行使能
- 目标转速/扭矩
- 控制模式
- 参数配置

6.7 寄存器映射表详细定义

【状态寄存器 0x0000-0x00FF (只读)】
地址    名称              数据类型    单位      说明
--------------------------------------------------------------------------------
0x0000  运行状态          UINT16      -         0=停止 1=运行 2=故障 3=待机
0x0001  实际转速          INT16       rpm       -30000~30000
0x0002  实际扭矩          INT16       0.1Nm     -3000~3000(对应-300.0~300.0Nm)
0x0003  母线电压          UINT16      0.1V      0~1000(对应0~100.0V)
0x0004  母线电流          INT16       0.1A      -5000~5000(对应-500.0~500.0A)
0x0005  输入功率          UINT16      0.1kW     0~1000(对应0~100.0kW)
0x0006  电机温度          INT16       0.1°C     -500~1500(对应-50.0~150.0°C)
0x0007  控制器温度        INT16       0.1°C     -500~1500(对应-50.0~150.0°C)
0x0008  转子位置          UINT16      0.1°      0~3600(对应0~360.0°)
0x0009  三相电流A         INT16       0.1A      -5000~5000
0x000A  三相电流B         INT16       0.1A      -5000~5000
0x000B  三相电流C         INT16       0.1A      -5000~5000
0x000C  运行时间(高位)    UINT16      秒        配合0x000D组成32位运行时间
0x000D  运行时间(低位)    UINT16      秒        
0x000E  PWM占空比         UINT16      0.1%      0~1000(对应0~100.0%)
0x000F  控制模式状态      UINT16      -         0=停止 1=速度 2=扭矩 3=位置
0x0010  Iq电流            INT16       0.1A      转矩分量电流
0x0011  Id电流            INT16       0.1A      励磁分量电流
0x0012  编码器脉冲数      UINT16      -         位置反馈值
0x0013  速度环输出        INT16       -         速度环控制器输出值
0x0014  位置环输出        INT16       -         位置环控制器输出值
0x0015  电能累计(高位)    UINT16      0.1kWh    配合0x0016组成32位累计电能
0x0016  电能累计(低位)    UINT16      0.1kWh    
0x0017  故障次数累计      UINT16      次        上电后故障发生总次数
0x0018~0x00FF 预留

【控制寄存器 0x0100-0x01FF (读写)】
地址    名称              数据类型    单位      说明
--------------------------------------------------------------------------------
0x0100  运行使能          UINT16      -         0=禁止 1=使能
0x0101  控制模式          UINT16      -         0=停止 1=速度 2=扭矩 3=位置
0x0102  目标转速          INT16       rpm       -30000~30000
0x0103  目标扭矩          INT16       0.1Nm     -3000~3000
0x0104  目标位置          INT16       0.1°      0~3600(一圈)或更大范围
0x0105  加速时间          UINT16      ms        0~30000(0表示最快加速)
0x0106  减速时间          UINT16      ms        0~30000(0表示最快减速)
0x0107  最大转速限制      UINT16      rpm       0~30000
0x0108  最大扭矩限制      UINT16      0.1Nm     0~3000
0x0109  紧急停止          UINT16      -         写1触发紧急停止
0x010A  故障复位          UINT16      -         写1清除可恢复故障
0x010B  功率限制          UINT16      0.1kW     0~1000(限制输入功率上限)
0x010C  再生制动使能      UINT16      -         0=禁止 1=使能
0x010D  回馈电流限制      UINT16      0.1A      0~5000
0x010E  回馈电压上限      UINT16      0.1V      0~1000
0x010F~0x01FF 预留

【参数寄存器 0x0200-0x02FF (读写,掉电保存)】
地址    名称              数据类型    单位      说明
--------------------------------------------------------------------------------
0x0200  设备地址          UINT16      -         1~247(Modbus从站地址)
0x0201  波特率配置        UINT16      -         0=9600 1=19200 2=38400 3=57600 4=115200
0x0202  电机极对数        UINT16      -         通常2~20
0x0203  额定电压          UINT16      0.1V      电机铭牌额定电压
0x0204  额定电流          UINT16      0.1A      电机铭牌额定电流
0x0205  额定功率          UINT16      0.1kW     电机铭牌额定功率
0x0206  额定转速          UINT16      rpm       电机铭牌额定转速
0x0207  过温保护阈值      UINT16      0.1°C     电机温度保护值
0x0208  过流保护阈值      UINT16      0.1A      瞬时过流保护值
0x0209  欠压保护阈值      UINT16      0.1V      母线欠压保护值
0x020A  过压保护阈值      UINT16      0.1V      母线过压保护值
0x020B  编码器类型        UINT16      -         0=无 1=霍尔 2=增量 3=绝对值
0x020C  编码器分辨率      UINT16      PPR       每转脉冲数
0x020D  速度环P增益       UINT16      0.001     比例增益×1000
0x020E  速度环I增益       UINT16      0.001     积分增益×1000
0x020F  位置环P增益       UINT16      0.001     比例增益×1000
0x0210  位置环I增益       UINT16      0.001     积分增益×1000
0x0211  电流环P增益       UINT16      0.001     比例增益×1000
0x0212  电流环I增益       UINT16      0.001     积分增益×1000
0x0213  PWM频率           UINT16      kHz       1~20(开关频率)
0x0214  死区时间          UINT16      0.1us     0~100(对应0~10us)
0x0215  软件版本号(高位)  UINT16      -         如v2.5.1 → 0x0002 0x0501
0x0216  软件版本号(低位)  UINT16      -         
0x0217  硬件版本号        UINT16      -         
0x0218  生产日期          UINT16      -         BCD格式 如0x2023表示2023年
0x0219  序列号(高位)      UINT16      -         设备唯一序列号
0x021A  序列号(低位)      UINT16      -         
0x021B~0x02FF 预留

【故障寄存器 0x0300-0x03FF (只读)】
地址    名称              数据类型    单位      说明
--------------------------------------------------------------------------------
0x0300  当前故障码        UINT16      -         位域(见下方故障码定义)
0x0301  历史故障1         UINT16      -         最近一次故障
0x0302  历史故障2         UINT16      -         倒数第二次故障
0x0303  历史故障3         UINT16      -         倒数第三次故障
0x0304  历史故障4         UINT16      -         倒数第四次故障
0x0305  历史故障5         UINT16      -         倒数第五次故障
0x0306~0x03FF 预留

故障码位域定义(Bit0-15):
  Bit0  过流故障
  Bit1  过压故障
  Bit2  欠压故障
  Bit3  电机过温故障
  Bit4  控制器过温故障
  Bit5  编码器故障
  Bit6  通讯超时故障
  Bit7  堵转故障
  Bit8  速度超限故障
  Bit9  位置跟随误差过大
  Bit10 硬件故障
  Bit11 IGBT故障
  Bit12 参数异常
  Bit13~15 预留


================================================================================
文档版本：v1.0
================================================================================
