# BMS-DTU通讯协议 (IEC104)

## 一、协议概述

### 1.1 通讯架构
```
EMS主控 ←→ [DTU_EMS] ←IEC104/TCP→ [DTU_BMS] ←→ BMS电池管理模块
           (控制站)                   (被控站)
```

### 1.2 DTU功能定位
- **DTU_EMS(控制站)**: 发起总召唤、接收遥测遥信、下发遥控遥调
- **DTU_BMS(被控站)**: 响应召唤、主动上报数据、执行控制指令

### 1.3 通讯参数
| 参数名称 | 默认值 | 可配置范围 | 说明 |
|---------|--------|-----------|------|
| 协议版本 | IEC 60870-5-104 | - | 国际标准 |
| 传输协议 | TCP/IP | - | 面向连接 |
| TCP端口 | 2404 | 1024~65535 | 标准端口2404 |
| 公共地址(ASDU) | 1 | 1~65535 | BMS设备地址 |
| 遥测上报周期 | 2秒 | 1~10秒 | 周期性上报 |
| 心跳周期 | 30秒 | 10~300秒 | 连接保活 |

---

## 二、DTU数据缓冲机制

### 2.1 DTU_EMS(控制站)缓冲
- **发送队列**: 512字节,存储待发送的I帧
- **接收队列**: 1024字节,存储BMS上报数据
- **确认窗口**: K=12,最多12帧未确认
- **超时设置**: t1=15s, t2=10s, t3=20s

### 2.2 DTU_BMS(被控站)缓冲
- **遥测缓冲区**: 存储最新的遥测值
- **遥信缓冲区**: 存储变位事件队列(最多100条)
- **指令队列**: 存储待执行的遥控遥调指令
- **响应延时**: \u003c100ms

---

## 三、IEC104帧格式

### 3.1 帧类型

#### I帧(信息帧) - 传输数据
```
字节0   字节1   字节2    字节3    字节4   字节5...
68      长度    发送序号  发送序号  接收序号 接收序号  ASDU数据...
起始符  (L)     (低)      (高)      (低)    (高)
```

#### S帧(监视帧) - 流量控制
```
字节0   字节1   字节2  字节3  字节4    字节5
68      04      01     00     接收序号  接收序号
起始符  长度    固定   固定   (低)      (高)
```

#### U帧(控制帧) - 连接管理
```
字节0   字节1   字节2  字节3  字节4  字节5
68      04      功能   00     00     00
起始符  长度    码
```

### 3.2 U帧功能码
| 功能码 | 名称 | 用途 |
|--------|------|------|
| 0x07 | STARTDT激活 | 启动数据传输 |
| 0x0B | STARTDT确认 | 确认启动 |
| 0x13 | STOPDT激活 | 停止数据传输 |
| 0x23 | STOPDT确认 | 确认停止 |
| 0x43 | TESTFR激活 | 测试链路 |
| 0x83 | TESTFR确认 | 确认测试 |

---

## 四、ASDU(应用服务数据单元)结构

### 4.1 ASDU格式
```
类型标识  可变结构限定词  传送原因  公共地址  信息体地址  信息元素
(1字节)   (1字节)        (2字节)   (2字节)   (3字节)     (变长)
```

### 4.2 类型标识(Type ID)

#### 遥测类型
| 类型ID | 名称 | 说明 |
|--------|------|------|
| 9 (0x09) | M_ME_NA_1 | 归一化测量值 |
| 11 (0x0B) | M_ME_NB_1 | 标度化测量值 |
| 13 (0x0D) | M_ME_NC_1 | 短浮点测量值 |

#### 遥信类型
| 类型ID | 名称 | 说明 |
|--------|------|------|
| 1 (0x01) | M_SP_NA_1 | 单点信息 |
| 3 (0x03) | M_DP_NA_1 | 双点信息 |

#### 遥控类型
| 类型ID | 名称 | 说明 |
|--------|------|------|
| 45 (0x2D) | C_SC_NA_1 | 单点命令 |
| 46 (0x2E) | C_DC_NA_1 | 双点命令 |

#### 遥调类型
| 类型ID | 名称 | 说明 |
|--------|------|------|
| 48 (0x30) | C_SE_NA_1 | 设定值命令(归一化) |
| 49 (0x31) | C_SE_NB_1 | 设定值命令(标度化) |
| 50 (0x32) | C_SE_NC_1 | 设定值命令(短浮点) |

#### 特殊类型
| 类型ID | 名称 | 说明 |
|--------|------|------|
| 100 (0x64) | C_IC_NA_1 | 总召唤命令 |
| 101 (0x65) | C_CI_NA_1 | 电能脉冲召唤 |

### 4.3 传送原因(COT)
| COT值 | 名称 | 说明 |
|-------|------|------|
| 1 | 周期循环 | 周期性上报 |
| 2 | 背景扫描 | 后台扫描 |
| 3 | 突发 | 变位上报 |
| 5 | 被请求 | 响应请求 |
| 6 | 激活 | 命令激活 |
| 7 | 激活确认 | 命令确认 |
| 8 | 停止激活 | 命令停止 |
| 9 | 停止激活确认 | 停止确认 |
| 10 | 激活终止 | 命令结束 |
| 20 | 响应总召唤 | 总召响应 |

---

## 五、IEC104数据点表

### 5.1 遥测(Telemetry) - 周期上报

#### 5.1.1 电池基本参数组 (IOA 1-20)
| IOA | 名称 | 类型 | 单位 | 量程/精度 | 上报周期 |
|-----|------|------|------|----------|---------|
| 1 | 总电压 | M_ME_NC_1 | V | 0~1000V | 2s |
| 2 | 总电流 | M_ME_NC_1 | A | -500~500A | 2s |
| 3 | 充电电流 | M_ME_NC_1 | A | 0~500A | 2s |
| 4 | 放电电流 | M_ME_NC_1 | A | 0~500A | 2s |
| 5 | SOC | M_ME_NB_1 | % | 0~100% | 2s |
| 6 | SOH | M_ME_NB_1 | % | 0~100% | 10s |
| 7 | 最高单体电压 | M_ME_NC_1 | V | 0~5.0V | 2s |
| 8 | 最低单体电压 | M_ME_NC_1 | V | 0~5.0V | 2s |
| 9 | 平均单体电压 | M_ME_NC_1 | V | 0~5.0V | 2s |
| 10 | 单体压差 | M_ME_NC_1 | mV | 0~2000mV | 2s |
| 11 | 最高温度 | M_ME_NC_1 | °C | -50~150°C | 2s |
| 12 | 最低温度 | M_ME_NC_1 | °C | -50~150°C | 2s |
| 13 | 平均温度 | M_ME_NC_1 | °C | -50~150°C | 2s |
| 14 | 温度差 | M_ME_NC_1 | °C | 0~100°C | 2s |
| 15 | 充电功率 | M_ME_NC_1 | kW | 0~500kW | 2s |
| 16 | 放电功率 | M_ME_NC_1 | kW | 0~500kW | 2s |
| 17 | 剩余容量 | M_ME_NC_1 | Ah | 0~1000Ah | 5s |
| 18 | 满充容量 | M_ME_NC_1 | Ah | 0~1000Ah | 10s |
| 19 | 循环次数 | M_ME_NB_1 | 次 | 0~65535 | 60s |
| 20 | DCL最大充电功率 | M_ME_NC_1 | kW | 0~500kW | 2s |

#### 5.1.2 动态限制组 (IOA 21-30)
| IOA | 名称 | 类型 | 单位 | 量程/精度 | 上报周期 |
|-----|------|------|------|----------|---------|
| 21 | CCL最大放电功率 | M_ME_NC_1 | kW | 0~500kW | 2s |
| 22 | 绝缘电阻(正极) | M_ME_NC_1 | kΩ | 0~10000kΩ | 5s |
| 23 | 绝缘电阻(负极) | M_ME_NC_1 | kΩ | 0~10000kΩ | 5s |
| 24 | 充电累计电量(高位) | M_ME_NC_1 | kWh | 配合25组成32位 | 10s |
| 25 | 充电累计电量(低位) | M_ME_NC_1 | kWh | - | 10s |
| 26 | 放电累计电量(高位) | M_ME_NC_1 | kWh | 配合27组成32位 | 10s |
| 27 | 放电累计电量(低位) | M_ME_NC_1 | kWh | - | 10s |
| 28 | 最高单体电压编号 | M_ME_NB_1 | - | 1~N | 变位 |
| 29 | 最低单体电压编号 | M_ME_NB_1 | - | 1~N | 变位 |
| 30 | 最高温度传感器编号 | M_ME_NB_1 | - | 1~N | 变位 |

#### 5.1.3 继电器状态组 (IOA 31-40)
| IOA | 名称 | 类型 | 单位 | 量程/精度 | 上报周期 |
|-----|------|------|------|----------|---------|
| 31 | 最低温度传感器编号 | M_ME_NB_1 | - | 1~N | 变位 |
| 32 | 正极继电器状态 | M_ME_NB_1 | - | 0=断开 1=闭合 | 变位 |
| 33 | 负极继电器状态 | M_ME_NB_1 | - | 0=断开 1=闭合 | 变位 |
| 34 | 预充继电器状态 | M_ME_NB_1 | - | 0=断开 1=闭合 | 变位 |
| 35 | 均衡工作状态 | M_ME_NB_1 | - | 0=停止 1=工作中 | 变位 |
| 36 | 运行时间 | M_ME_NC_1 | s | 累计运行时间 | 60s |
| 37~100 | 预留 | - | - | - | - |

### 5.2 遥信(Status) - 变位上报

#### 5.2.1 运行状态组 (IOA 1001-1010)
| IOA | 名称 | 类型 | 说明 |
|-----|------|------|------|
| 1001 | 充电状态 | M_SP_NA_1 | 0=未充电 1=充电中 |
| 1002 | 放电状态 | M_SP_NA_1 | 0=未放电 1=放电中 |
| 1003 | 系统就绪 | M_SP_NA_1 | 0=未就绪 1=就绪 |
| 1004 | 系统故障 | M_SP_NA_1 | 0=正常 1=故障 |

#### 5.2.2 故障告警组 (IOA 1010-1035)
| IOA | 名称 | 类型 | 故障等级 |
|-----|------|------|---------|
| 1010 | 单体过压告警 | M_SP_NA_1 | L4 |
| 1011 | 单体欠压告警 | M_SP_NA_1 | L4 |
| 1012 | 总压过压告警 | M_SP_NA_1 | L4 |
| 1013 | 总压欠压告警 | M_SP_NA_1 | L3 |
| 1014 | 充电过流告警 | M_SP_NA_1 | L3 |
| 1015 | 放电过流告警 | M_SP_NA_1 | L3 |
| 1016 | 短路告警 | M_SP_NA_1 | L4 |
| 1017 | 充电高温告警 | M_SP_NA_1 | L3 |
| 1018 | 充电低温告警 | M_SP_NA_1 | L3 |
| 1019 | 放电高温告警 | M_SP_NA_1 | L3 |
| 1020 | 放电低温告警 | M_SP_NA_1 | L2 |
| 1021 | 单体压差过大告警 | M_SP_NA_1 | L2 |
| 1022 | 温差过大告警 | M_SP_NA_1 | L2 |
| 1023 | 绝缘故障告警 | M_SP_NA_1 | L4 |
| 1024 | SOC过低告警 | M_SP_NA_1 | L2 |
| 1025 | SOC过高告警 | M_SP_NA_1 | L2 |
| 1026 | SOH过低告警 | M_SP_NA_1 | L1 |
| 1027 | 均衡故障告警 | M_SP_NA_1 | L2 |
| 1028 | 正极继电器故障 | M_SP_NA_1 | L4 |
| 1029 | 负极继电器故障 | M_SP_NA_1 | L4 |
| 1030 | 预充继电器故障 | M_SP_NA_1 | L4 |
| 1031 | 预充超时故障 | M_SP_NA_1 | L4 |
| 1032 | 通讯故障 | M_SP_NA_1 | L4 |
| 1033 | 采集板故障 | M_SP_NA_1 | L4 |
| 1034 | EEPROM故障 | M_SP_NA_1 | L4 |
| 1035~1050 | 预留 | - | - |

#### 5.2.3 保护动作标志组 (IOA 1051-1070)
| IOA | 名称 | 类型 | 说明 |
|-----|------|------|------|
| 1051 | 过压保护动作 | M_SP_NA_1 | 0=未动作 1=已动作 |
| 1052 | 欠压保护动作 | M_SP_NA_1 | 0=未动作 1=已动作 |
| 1053 | 过流保护动作 | M_SP_NA_1 | 0=未动作 1=已动作 |
| 1054 | 短路保护动作 | M_SP_NA_1 | 0=未动作 1=已动作 |
| 1055 | 过温保护动作 | M_SP_NA_1 | 0=未动作 1=已动作 |
| 1056 | 低温保护动作 | M_SP_NA_1 | 0=未动作 1=已动作 |
| 1057 | 绝缘保护动作 | M_SP_NA_1 | 0=未动作 1=已动作 |
| 1058~1070 | 预留 | - | - |

### 5.3 遥控(Control) - EMS下发

| IOA | 名称 | 类型 | 说明 |
|-----|------|------|------|
| 2001 | 充电使能 | C_SC_NA_1 | 0=禁止 1=使能 |
| 2002 | 放电使能 | C_SC_NA_1 | 0=禁止 1=使能 |
| 2003 | 紧急停止 | C_SC_NA_1 | 写1触发紧急停机 |
| 2004 | 故障复位 | C_SC_NA_1 | 写1清除可恢复故障 |
| 2005 | 均衡启动 | C_SC_NA_1 | 0=停止 1=启动 |
| 2006 | 继电器总控 | C_SC_NA_1 | 0=断开 1=闭合 |
| 2007 | 正极继电器控制 | C_SC_NA_1 | 0=断开 1=闭合 |
| 2008 | 负极继电器控制 | C_SC_NA_1 | 0=断开 1=闭合 |
| 2009 | 预充继电器控制 | C_SC_NA_1 | 0=断开 1=闭合 |
| 2010 | 数据清零 | C_SC_NA_1 | 写1清除统计数据 |
| 2011~2050 | 预留 | - | - |

### 5.4 遥调(Setting) - 参数设置

| IOA | 名称 | 类型 | 单位 | 量程 |
|-----|------|------|------|------|
| 3001 | 充电功率限制 | C_SE_NC_1 | kW | 0~500kW |
| 3002 | 放电功率限制 | C_SE_NC_1 | kW | 0~500kW |
| 3003 | 充电电流限制 | C_SE_NC_1 | A | 0~500A |
| 3004 | 放电电流限制 | C_SE_NC_1 | A | 0~500A |
| 3005 | SOC下限设置 | C_SE_NB_1 | % | 10~30% |
| 3006 | SOC上限设置 | C_SE_NB_1 | % | 80~100% |
| 3007 | 过压保护阈值 | C_SE_NC_1 | V | 3.50~4.20V |
| 3008 | 欠压保护阈值 | C_SE_NC_1 | V | 2.00~3.00V |
| 3009 | 过流保护阈值 | C_SE_NC_1 | A | 100~500A |
| 3010 | 高温保护阈值 | C_SE_NC_1 | °C | 35~60°C |
| 3011 | 低温保护阈值 | C_SE_NC_1 | °C | -20~10°C |
| 3012 | 均衡启动电压差 | C_SE_NC_1 | mV | 10~100mV |
| 3013~3050 | 预留 | - | - | - |

---

## 六、IEC104通讯示例

### 6.1 连接建立流程
```
EMS → BMS: [68 04 07 00 00 00]  // STARTDT激活
BMS → EMS: [68 04 0B 00 00 00]  // STARTDT确认
连接建立成功
```

### 6.2 总召唤流程
```
步骤1: EMS发送总召唤命令
[68 0E 02 00 00 00 64 01 06 00 01 00 00 00 00 14 00]
│  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  └─限定词
│  │  │  │  │  │  │  │  │  │  │  │  └──────────IOA=0(所有)
│  │  │  │  │  │  │  │  │  └──────公共地址=1
│  │  │  │  │  │  │  └──────传送原因=6(激活)
│  │  │  │  │  │  └───可变结构限定词=1
│  │  │  │  │  └────类型标识=100(总召唤)
│  │  └──────────发送序号=2
│  └───────────长度=14
└────────────起始符68

步骤2: BMS确认总召唤
[68 0E 04 00 02 00 64 01 07 00 01 00 00 00 00 14 00]
                        └─传送原因=7(激活确认)

步骤3: BMS上报所有遥测点(COT=20 响应总召唤)
遥测点1: [68 10 06 00 04 00 0D 01 14 00 01 00 01 00 00 42 61 E1 43]
                              └─COT=20      └─IOA=1  └─IEEE754浮点(450.5V)

步骤4: BMS上报所有遥信点(COT=20)
遥信点1001: [68 0F 08 00 06 00 01 01 14 00 01 00 E9 03 00 01 00]
                                  └─COT=20      └─IOA=1001 └─值=1

步骤5: BMS总召唤结束
[68 0E 0A 00 08 00 64 01 0A 00 01 00 00 00 00 14 00]
                        └─传送原因=10(激活终止)
```

### 6.3 遥测周期上报示例
```
// BMS每2秒上报总电压(IOA=1)
[68 10 00 00 00 00 0D 01 01 00 01 00 01 00 00 42 61 E1 43]
│  │  │  │  │  │  │  │  │  │  │  │  │  │  │  └───────────IEEE754(450.5V)
│  │  │  │  │  │  │  │  │  │  │  │  └──────────IOA=1(总电压)
│  │  │  │  │  │  │  │  │  └──────公共地址=1
│  │  │  │  │  │  │  └──────传送原因=1(周期循环)
│  │  │  │  │  │  └───可变结构限定词=1
│  │  │  │  │  └────类型标识=13(短浮点)
│  │  └──────────发送序号=0
│  └───────────长度=16
└────────────起始符68
```

### 6.4 遥信变位上报示例
```
// 充电状态从0变为1(IOA=1001)
[68 0F 00 00 00 00 01 01 03 00 01 00 E9 03 00 01 00]
│  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  └─值=1(充电中)
│  │  │  │  │  │  │  │  │  │  │  │  └──────────IOA=1001
│  │  │  │  │  │  │  │  │  └──────公共地址=1
│  │  │  │  │  │  │  └──────传送原因=3(突发/变位)
│  │  │  │  │  │  └───可变结构限定词=1
│  │  │  │  │  └────类型标识=1(单点信息)
│  │  └──────────发送序号=0
│  └───────────长度=15
└────────────起始符68
```

### 6.5 遥控命令示例
```
// EMS发送充电使能命令(IOA=2001)
[68 0F 02 00 00 00 2D 01 06 00 01 00 D1 07 00 01 00]
│  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  └─值=1(使能)
│  │  │  │  │  │  │  │  │  │  │  │  └──────────IOA=2001
│  │  │  │  │  │  │  │  │  └──────公共地址=1
│  │  │  │  │  │  │  └──────传送原因=6(激活)
│  │  │  │  │  │  └───可变结构限定词=1
│  │  │  │  │  └────类型标识=45(单点命令)
│  │  └──────────发送序号=2
│  └───────────长度=15
└────────────起始符68

// BMS响应确认
[68 0F 04 00 02 00 2D 01 07 00 01 00 D1 07 00 01 00]
                        └─传送原因=7(激活确认)
```

### 6.6 遥调命令示例
```
// EMS设置充电功率限制为60kW (IOA=3001)
[68 12 02 00 00 00 32 01 06 00 01 00 D9 0B 00 00 00 70 42]
│  │  │  │  │  │  │  │  │  │  │  │  │  │  │  └─────────IEEE754(60.0)
│  │  │  │  │  │  │  │  │  │  │  │  └──────────IOA=3001
│  │  │  │  │  │  │  │  │  └──────公共地址=1
│  │  │  │  │  │  │  └──────传送原因=6(激活)
│  │  │  │  │  │  └───可变结构限定词=1
│  │  │  │  │  └────类型标识=50(短浮点设定值)
│  │  └──────────发送序号=2
│  └───────────长度=18
└────────────起始符68
```

---

## 七、DTU通讯流程

### 7.1 连接管理

#### 连接建立
```
1. TCP三次握手(EMS主动连接BMS的2404端口)
2. EMS发送STARTDT激活
3. BMS响应STARTDT确认
4. 连接建立,进入数据传输状态
```

#### 心跳保活
```
每30秒:
EMS → BMS: [68 04 43 00 00 00]  // TESTFR激活
BMS → EMS: [68 04 83 00 00 00]  // TESTFR确认
```

#### 连接断开
```
1. EMS发送STOPDT激活
2. BMS响应STOPDT确认
3. TCP四次挥手
```

### 7.2 数据传输流程

#### 初始化(总召唤)
```
1. 连接建立后,EMS发送总召唤命令
2. BMS确认总召唤
3. BMS上报所有遥测点(COT=20)
4. BMS上报所有遥信点(COT=20)
5. BMS发送总召唤结束
```

#### 周期上报
```
每2秒:
  BMS主动上报遥测数据(COT=1 周期循环)
  遥测点按IOA顺序逐个上报(可合并多点)
```

#### 变位上报
```
遥信状态变化时:
  BMS立即上报变位点(COT=3 突发)
  同一点位短时间内多次变化,仅上报最终状态
```

#### 命令执行
```
遥控流程:
  1. EMS发送命令(COT=6 激活)
  2. BMS响应确认(COT=7 激活确认)
  3. BMS执行命令
  4. 状态变化通过遥信变位上报

遥调流程:
  1. EMS发送设定值(COT=6 激活)
  2. BMS响应确认(COT=7 激活确认)
  3. BMS应用新参数
  4. 参数生效,后续遥测值反映变化
```

### 7.3 流量控制

#### 发送窗口机制
```
- K值=12: 最多12帧I帧未确认
- 当未确认帧达到K值时,停止发送,等待确认
- 接收方通过S帧确认接收序号
```

#### 超时机制
```
- t1=15s: 发送I/U帧后未收到确认的超时
- t2=10s: 接收方确认延时(无数据发送时最迟确认时间)
- t3=20s: 测试帧响应超时
```

---

## 八、DTU配置参数

### 8.1 DTU_EMS配置
```c
// 控制站配置
iec104_master_config_t ems_dtu_config = {
    .server_ip = "192.168.1.100",      // BMS的IP地址
    .server_port = 2404,                // IEC104标准端口
    .asdu_address = 1,                  // BMS公共地址
    .k_value = 12,                      // 发送窗口
    .w_value = 8,                       // 接收窗口
    .t1_timeout_ms = 15000,            // 确认超时
    .t2_timeout_ms = 10000,            // 确认延时
    .t3_timeout_ms = 20000,            // 测试超时
    .auto_reconnect = true,            // 断线自动重连
    .reconnect_interval_s = 10         // 重连间隔
};
```

### 8.2 DTU_BMS配置
```c
// 被控站配置
iec104_slave_config_t bms_dtu_config = {
    .listen_port = 2404,               // 监听端口
    .asdu_address = 1,                 // 本站地址
    .max_clients = 1,                  // 最大连接数
    .telemetry_period_s = 2,           // 遥测上报周期
    .heartbeat_period_s = 30,          // 心跳周期
    .event_queue_size = 100,           // 变位队列大小
    .k_value = 12,
    .w_value = 8
};
```

---

## 九、典型应用场景

### 9.1 启动充电控制
```c
// 1. 发送充电使能命令
iec104_send_single_cmd(asdu_addr=1, ioa=2001, value=1, cot=6);

// 2. 等待BMS确认
// BMS响应: COT=7(激活确认)

// 3. BMS状态变化自动上报
// 遥信1001(充电状态)从0变为1, COT=3(突发)

// 4. 遥测值开始反映充电电流和功率
// IOA=3(充电电流) 周期上报非零值
```

### 9.2 设置充电功率限制
```c
// 1. 发送遥调命令,设置60kW限制
float power_limit = 60.0; // kW
iec104_send_float_setpoint(asdu_addr=1, ioa=3001, value=power_limit, cot=6);

// 2. 等待BMS确认
// BMS响应: COT=7(激活确认)

// 3. 后续遥测值不超过设定限制
// IOA=15(充电功率) 上报值≤60kW
```

### 9.3 故障处理
```c
// 1. BMS检测到单体过压故障
// 遥信1010(单体过压告警)变位: 0→1, COT=3
// 遥信1051(过压保护动作)变位: 0→1, COT=3
// 遥信1001(充电状态)变位: 1→0, COT=3

// 2. EMS读取遥信确认故障类型

// 3. 故障消除后,EMS发送复位命令
iec104_send_single_cmd(asdu_addr=1, ioa=2004, value=1, cot=6);

// 4. BMS响应并清除故障
// 遥信1010恢复: 1→0, COT=3
// 遥信1051恢复: 1→0, COT=3
```

### 9.4 总召唤刷新
```c
// 周期性总召唤(如每小时一次)
// 确保所有数据同步

iec104_send_general_interrogation(asdu_addr=1, qoi=20, cot=6);

// BMS响应所有遥测/遥信点
// COT=20(响应总召唤)
```

---

## 十、DTU故障诊断

### 10.1 常见故障及处理

| 故障现象 | 可能原因 | 排查方法 |
|---------|---------|---------|
| 连接失败 | IP/端口配置错误 | 检查网络配置和防火墙 |
| 无数据上报 | BMS未启动数据传输 | 检查STARTDT流程 |
| 心跳超时 | 网络不稳定 | 检查网络延迟和丢包率 |
| 数据异常 | IOA地址映射错误 | 核对数据点表 |
| 命令无响应 | 权限不足或BMS故障 | 检查BMS状态和日志 |

### 10.2 调试工具建议
- **Wireshark**: 抓包分析IEC104协议
- **IEC104模拟器**: 模拟控制站/被控站
- **TCP调试工具**: 测试TCP连接

---

## 十一、性能指标

| 指标名称 | 数值 | 说明 |
|---------|------|------|
| 遥测上报周期 | 2s | 重要参数实时更新 |
| 遥信上报延时 | \u003c100ms | 变位立即上报 |
| 命令执行时间 | \u003c200ms | 从发送到确认 |
| 连接建立时间 | \u003c1s | TCP握手+STARTDT |
| 数据刷新率 | 0.5Hz | 每秒0.5次遥测更新 |
| 最大并发连接 | 1 | 单控制站连接 |

---

## 十二、安全机制

### 12.1 访问控制
- **IP白名单**: 仅允许授权EMS连接
- **会话管理**: 单一控制站连接,拒绝重复连接
- **命令验证**: 检查命令合法性和参数范围

### 12.2 数据完整性
- **序号机制**: 发送/接收序号防止丢帧
- **超时重传**: 未确认帧自动重传
- **变位队列**: 防止变位事件丢失

### 12.3 故障恢复
- **自动重连**: 断线后自动重连
- **状态恢复**: 重连后执行总召唤刷新状态
- **数据补发**: 断线期间的变位事件缓存后补发

---

## 十三、与其他协议联动

### 13.1 BMS故障 → EMS仲裁
```
BMS检测到过压故障:
  1. 遥信1010(单体过压告警) 变位上报
  2. 遥信1051(过压保护动作) 变位上报
  3. DTU_EMS接收并解析
  4. EMS主控执行仲裁策略:
     - 通知充电桩停止充电(OCPP)
     - 通知FOC停止电机(Modbus)
     - 断开高压继电器
```

### 13.2 EMS功率调度 → BMS限制
```
EMS根据负载情况调整充电功率:
  1. 计算当前可用功率
  2. 通过遥调设置BMS充电功率限制(IOA=3001)
  3. BMS应用新限制
  4. 充电桩根据BMS的DCL值调整输出
```

---

## 十四、注意事项

### 14.1 实时性
- 遥信变位应立即上报,延时\u003c100ms
- 遥测周期不宜过短,避免网络拥塞
- 命令执行应优先处理,不被遥测阻塞

### 14.2 数据一致性
- 总召唤后确保所有点位完整上报
- 遥测值应携带时间戳(如需要)
- 变位事件按时序上报

### 14.3 异常处理
- 网络断线后缓存变位事件,重连后补发
- 命令执行失败应通过否定确认上报
- 参数越界应拒绝并记录日志

### 14.4 扩展性
- 预留IOA地址空间供未来扩展
- 支持多点合并传输提高效率
- 支持时间标签(可选)

---

## 十五、协议扩展说明

### 15.1 时间标签
若需要精确时间戳,可使用带时间标签的类型:
- M_ME_NC_1 → M_ME_TF_1 (带CP56Time2a)
- M_SP_NA_1 → M_SP_TB_1 (带CP56Time2a)

### 15.2 多点传输
单个ASDU可包含多个信息体,提高效率:
```
[68 XX ... 0D 10 01 00 01 00 ...]
         └─可变结构限定词=16(16个点位)
```

### 15.3 电能脉冲召唤
用于精确计量,可定期召唤电能累计值:
```
EMS发送: C_CI_NA_1 (类型101)
BMS响应: M_IT_TB_1 (类型7, 带时间戳的累计量)
```

---

**文档版本**: v1.0  
**编制日期**: 2025-12-20  
**协议类型**: IEC 60870-5-104  
**通信接口**: TCP/IP  
