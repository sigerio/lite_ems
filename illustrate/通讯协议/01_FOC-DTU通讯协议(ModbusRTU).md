# FOC-DTU通讯协议 (Modbus RTU)

## 一、协议概述

### 1.1 通讯架构
```
EMS主控 ←→ [DTU_EMS] ←Modbus RTU→ [DTU_FOC] ←→ FOC电机控制模块
           (主站)                    (从站)
```

### 1.2 DTU功能定位
- **DTU_EMS(主站端)**: 负责发起查询、下发指令、接收响应
- **DTU_FOC(从站端)**: 负责响应查询、执行指令、上报状态

### 1.3 通讯参数
| 参数名称 | 默认值 | 可配置范围 | 说明 |
|---------|--------|-----------|------|
| 波特率 | 115200 bps | 9600/19200/38400/57600/115200 | 通过寄存器0x0201配置 |
| 数据位 | 8位 | 固定 | - |
| 停止位 | 1位 | 固定 | - |
| 校验位 | 无校验 | 无/奇/偶 | 建议无校验+CRC16 |
| 从站地址 | 1 | 1~247 | 通过寄存器0x0200配置 |
| 轮询周期 | 20ms | 10~100ms | EMS主控配置 |

---

## 二、DTU数据缓冲机制

### 2.1 DTU_EMS(主站)缓冲
- **发送缓冲区**: 256字节,存储待发送的Modbus帧
- **接收缓冲区**: 256字节,存储FOC响应数据
- **超时设置**: 100ms,超时重传最多3次

### 2.2 DTU_FOC(从站)缓冲
- **接收缓冲区**: 256字节,存储主站请求
- **发送缓冲区**: 256字节,存储响应数据
- **响应延时**: <10ms

说明：主站超时需≥从站响应延时+总线转向时间+CRC校验时间，100ms满足要求。

---

## 三、Modbus功能码定义

### 3.1 支持的功能码
| 功能码 | 名称 | 用途 | 数据方向 |
|--------|------|------|---------|
| 0x03 | 读保持寄存器 | 读取状态/参数 | EMS→FOC |
| 0x06 | 写单个寄存器 | 修改单个参数 | EMS→FOC |
| 0x10 | 写多个寄存器 | 批量配置参数 | EMS→FOC |

### 3.2 异常响应码
| 异常码 | 含义 | 处理方式 |
|--------|------|---------|
| 0x01 | 非法功能码 | 检查功能码是否支持 |
| 0x02 | 非法地址 | 检查寄存器地址范围 |
| 0x03 | 非法数据值 | 检查数据范围 |
| 0x04 | 从站设备故障 | FOC模块异常,需排查 |

---

## 四、寄存器地址映射表

### 4.1 状态寄存器 (0x0000-0x00FF, 只读)

#### 4.1.1 运行状态组 (0x0000-0x000F)
| 地址 | 名称 | 数据类型 | 单位 | 量程/说明 | 上报周期 |
|------|------|---------|------|----------|---------|
| 0x0000 | 运行状态 | UINT16 | - | 0=停止 1=运行 2=故障 3=待机 | 实时 |
| 0x0001 | 实际转速 | INT16 | rpm | -30000~30000 | 20ms |
| 0x0002 | 实际扭矩 | INT16 | 0.1Nm | -3000~3000 (±300.0Nm) | 20ms |
| 0x0003 | 母线电压 | UINT16 | 0.1V | 0~1000 (0~100.0V) | 20ms |
| 0x0004 | 母线电流 | INT16 | 0.1A | -5000~5000 (±500.0A) | 20ms |
| 0x0005 | 输入功率 | UINT16 | 0.1kW | 0~1000 (0~100.0kW) | 20ms |
| 0x0006 | 电机温度 | INT16 | 0.1°C | -500~1500 (-50.0~150.0°C) | 1s |
| 0x0007 | 控制器温度 | INT16 | 0.1°C | -500~1500 (-50.0~150.0°C) | 1s |
| 0x0008 | 转子位置 | UINT16 | 0.1° | 0~3600(单圈，0.1°/位) | 20ms |
| 0x0009 | 三相电流A | INT16 | 0.1A | -5000~5000 | 20ms |
| 0x000A | 三相电流B | INT16 | 0.1A | -5000~5000 | 20ms |
| 0x000B | 三相电流C | INT16 | 0.1A | -5000~5000 | 20ms |
| 0x000C | 运行时间(高位) | UINT16 | 秒 | 配合0x000D组成32位 | 1s |
| 0x000D | 运行时间(低位) | UINT16 | 秒 | - | 1s |
| 0x000E | PWM占空比 | UINT16 | 0.1% | 0~1000 (0~100.0%) | 20ms |
| 0x000F | 控制模式状态 | UINT16 | - | 0=停止 1=速度 2=扭矩 3=位置 | 实时 |

说明：运行时间 = (0x000C<<16 | 0x000D) 秒，上电清零，约49.7天回绕。
说明：单圈位置超过3600按取模回绕。
说明：输入功率(0x0005)仅表示正向输入功率，不作为回馈功率指示。

#### 4.1.2 控制环状态组 (0x0010-0x001F)
| 地址 | 名称 | 数据类型 | 单位 | 量程/说明 | 上报周期 |
|------|------|---------|------|----------|---------|
| 0x0010 | Iq电流 | INT16 | 0.1A | 转矩分量电流 | 20ms |
| 0x0011 | Id电流 | INT16 | 0.1A | 励磁分量电流 | 20ms |
| 0x0012 | 编码器脉冲数 | UINT16 | - | 0~65535，回绕；仅为计数快照 | 20ms |
| 0x0013 | 速度环输出 | INT16 | - | 速度环控制器输出值 | 20ms |
| 0x0014 | 位置环输出 | INT16 | - | 位置环控制器输出值 | 20ms |
| 0x0015 | 电能累计(高位) | UINT16 | 0.1kWh | 配合0x0016组成32位 | 1s |
| 0x0016 | 电能累计(低位) | UINT16 | 0.1kWh | - | 1s |
| 0x0017 | 故障次数累计 | UINT16 | 次 | 上电后故障发生总次数 | 变位 |
| 0x0018~0x00FF | 预留 | - | - | - | - |

### 4.2 控制寄存器 (0x0100-0x01FF, 读写)

#### 4.2.1 基本控制组 (0x0100-0x010F)
| 地址 | 名称 | 数据类型 | 单位 | 量程/说明 | 默认值 |
|------|------|---------|------|----------|--------|
| 0x0100 | 运行使能 | UINT16 | - | 0=禁止 1=使能 | 0 |
| 0x0101 | 控制模式 | UINT16 | - | 0=停止 1=速度 2=扭矩 3=位置 | 0 |
| 0x0102 | 目标转速 | INT16 | rpm | -30000~30000 | 0 |
| 0x0103 | 目标扭矩 | INT16 | 0.1Nm | -3000~3000 | 0 |
| 0x0104 | 目标位置 | INT16 | 0.1° | 0~3600(单圈，0.1°/位) | 0 |
| 0x0105 | 加速时间 | UINT16 | ms | 0~30000 (0表示最快) | 2000 |
| 0x0106 | 减速时间 | UINT16 | ms | 0~30000 (0表示最快) | 2000 |
| 0x0107 | 最大转速限制 | UINT16 | rpm | 0~30000 | 3000 |
| 0x0108 | 最大扭矩限制 | UINT16 | 0.1Nm | 0~3000 | 1000 |
| 0x0109 | 紧急停止 | UINT16 | - | 写1触发紧急停止，执行后自清零(边沿有效) | 0 |
| 0x010A | 故障复位 | UINT16 | - | 写1清除可恢复故障；故障已消除且运行使能=0时有效，执行后自清零 | 0 |
| 0x010B | 功率限制 | UINT16 | 0.1kW | 0~1000 限制输入功率上限 | 500 |
| 0x010C | 再生制动使能 | UINT16 | - | 0=禁止 1=使能 | 0 |
| 0x010D | 回馈电流限制 | UINT16 | 0.1A | 0~5000 | 1000 |
| 0x010E | 回馈电压上限 | UINT16 | 0.1V | 0~1000 | 600 |
| 0x010F~0x01FF | 预留 | - | - | - | - |

说明：功率/回馈相关寄存器均为非负上限，不接受负值；回馈通过0x010C~0x010E约束。

### 4.3 参数寄存器 (0x0200-0x02FF, 读写, 掉电保存)
#### 4.3.1 通讯配置组 (0x0200-0x020F)
| 地址 | 名称 | 数据类型 | 单位 | 量程/说明 | 默认值 |
|------|------|---------|------|----------|--------|
| 0x0200 | 设备地址 | UINT16 | - | 1~247 (Modbus从站地址) | 1 |
| 0x0201 | 波特率配置 | UINT16 | - | 0=9600 1=19200 2=38400 3=57600 4=115200 | 4 |

#### 4.3.2 电机参数组 (0x0202-0x020F)
| 地址 | 名称 | 数据类型 | 单位 | 量程/说明 | 默认值 |
|------|------|---------|------|----------|--------|
| 0x0202 | 电机极对数 | UINT16 | - | 2~20 | 4 |
| 0x0203 | 额定电压 | UINT16 | 0.1V | 100~1000 | 480 |
| 0x0204 | 额定电流 | UINT16 | 0.1A | 100~5000 | 1000 |
| 0x0205 | 额定功率 | UINT16 | 0.1kW | 10~1000 | 50 |
| 0x0206 | 额定转速 | UINT16 | rpm | 100~30000 | 3000 |

#### 4.3.3 保护阈值组 (0x0207-0x020F)
| 地址 | 名称 | 数据类型 | 单位 | 量程/说明 | 默认值 |
|------|------|---------|------|----------|--------|
| 0x0207 | 过温保护阈值 | UINT16 | 0.1°C | 500~1500 | 800 |
| 0x0208 | 过流保护阈值 | UINT16 | 0.1A | 500~5000 | 1200 |
| 0x0209 | 欠压保护阈值 | UINT16 | 0.1V | 100~500 | 300 |
| 0x020A | 过压保护阈值 | UINT16 | 0.1V | 500~1000 | 600 |

#### 4.3.4 编码器配置组 (0x020B-0x020F)
| 地址 | 名称 | 数据类型 | 单位 | 量程/说明 | 默认值 |
|------|------|---------|------|----------|--------|
| 0x020B | 编码器类型 | UINT16 | - | 0=无 1=霍尔 2=增量 3=绝对值 | 2 |
| 0x020C | 编码器分辨率 | UINT16 | PPR | 100~10000 | 1024 |

#### 4.3.5 PID增益参数组 (0x020D-0x0212)
| 地址 | 名称 | 数据类型 | 单位 | 量程/说明 | 默认值 |
|------|------|---------|------|----------|--------|
| 0x020D | 速度环P增益 | UINT16 | 0.001 | 1~10000 | 500 |
| 0x020E | 速度环I增益 | UINT16 | 0.001 | 1~5000 | 100 |
| 0x020F | 位置环P增益 | UINT16 | 0.001 | 1~10000 | 800 |
| 0x0210 | 位置环I增益 | UINT16 | 0.001 | 1~5000 | 50 |
| 0x0211 | 电流环P增益 | UINT16 | 0.001 | 1~5000 | 300 |
| 0x0212 | 电流环I增益 | UINT16 | 0.001 | 1~5000 | 150 |

说明：实际增益=寄存器值×0.001。

#### 4.3.6 PWM配置组 (0x0213-0x0214)
| 地址 | 名称 | 数据类型 | 单位 | 量程/说明 | 默认值 |
|------|------|---------|------|----------|--------|
| 0x0213 | PWM频率 | UINT16 | kHz | 1~20 | 10 |
| 0x0214 | 死区时间 | UINT16 | 0.1us | 0~100 | 20 |

#### 4.3.7 设备信息组 (0x0215-0x021A)
| 地址 | 名称 | 数据类型 | 单位 | 量程/说明 | 示例 |
|------|------|---------|------|----------|------|
| 0x0215 | 软件版本号(高位) | UINT16 | - | 主版本(十进制) | 2 |
| 0x0216 | 软件版本号(低位) | UINT16 | - | 高字节=次版本，低字节=修订(十进制) | 1281 |
| 0x0217 | 硬件版本号 | UINT16 | - | - | 1 |
| 0x0218 | 生产日期 | UINT16 | - | 生产年份(BCD，YYYY) | 8227 |
| 0x0219 | 序列号(高位) | UINT16 | - | 设备唯一序列号 | - |
| 0x021A | 序列号(低位) | UINT16 | - | - | - |
| 0x021B~0x02FF | 预留 | - | - | - | - |

说明：示例 v2.5.1 → 0x0215=0x0002, 0x0216=0x0501。

### 4.4 故障寄存器 (0x0300-0x03FF, 只读)

| 地址 | 名称 | 数据类型 | 单位 | 说明 |
|------|------|---------|------|------|
| 0x0300 | 当前故障码 | UINT16 | - | 位域(见故障码定义) |
| 0x0301 | 历史故障1 | UINT16 | - | 最近一次故障 |
| 0x0302 | 历史故障2 | UINT16 | - | 倒数第二次故障 |
| 0x0303 | 历史故障3 | UINT16 | - | 倒数第三次故障 |
| 0x0304 | 历史故障4 | UINT16 | - | 倒数第四次故障 |
| 0x0305 | 历史故障5 | UINT16 | - | 倒数第五次故障 |
| 0x0306~0x03FF | 预留 | - | - | - |

说明：0x0301~0x0305 为故障位域快照(与0x0300格式一致)。

#### 4.4.1 故障码位域定义 (Bit0-15)
```
Bit0  - 过流故障
Bit1  - 过压故障
Bit2  - 欠压故障
Bit3  - 电机过温故障
Bit4  - 控制器过温故障
Bit5  - 编码器故障
Bit6  - 通讯超时故障
Bit7  - 堵转故障
Bit8  - 速度超限故障
Bit9  - 位置跟随误差过大
Bit10 - 硬件故障
Bit11 - IGBT故障
Bit12 - 参数异常
Bit13~15 - 预留
```

---

## 五、Modbus数据帧格式

### 5.1 读保持寄存器 (0x03)

#### 请求帧格式
```
字节索引   字段名称       示例值(Hex)   说明
----------------------------------------------
0          从站地址       01            FOC设备地址
1          功能码         03            读保持寄存器
2          起始地址高字节  00            寄存器地址高8位
3          起始地址低字节  00            寄存器地址低8位
4          寄存器数量高    00            读取数量高8位
5          寄存器数量低    10            读取数量低8位(16个)
6          CRC校验低字节   44            CRC16-Modbus
7          CRC校验高字节   0C            CRC16-Modbus
```

#### 响应帧格式
```
字节索引   字段名称       示例值(Hex)   说明
----------------------------------------------
0          从站地址       01            FOC设备地址
1          功能码         03            读保持寄存器
2          字节数         20            返回字节数(16个寄存器×2字节)
3          数据1高字节    00            第1个寄存器高字节
4          数据1低字节    01            第1个寄存器低字节
...        ...            ...           ...
34         数据16低字节   XX            第16个寄存器低字节
35         CRC校验低字节  XX            CRC16-Modbus
36         CRC校验高字节  XX            CRC16-Modbus
```

### 5.2 写单个寄存器 (0x06)

#### 请求帧格式
```
字节索引   字段名称       示例值(Hex)   说明
----------------------------------------------
0          从站地址       01            FOC设备地址
1          功能码         06            写单个寄存器
2          寄存器地址高    01            地址0x0100
3          寄存器地址低    00            运行使能
4          数据高字节     00            值=1
5          数据低字节     01            使能运行
6          CRC校验低字节  XX            CRC16-Modbus
7          CRC校验高字节  XX            CRC16-Modbus
```

#### 响应帧格式
```
响应帧与请求帧完全相同(回显)
```

### 5.3 写多个寄存器 (0x10)

#### 请求帧格式
```
字节索引   字段名称       示例值(Hex)   说明
----------------------------------------------
0          从站地址       01            FOC设备地址
1          功能码         10            写多个寄存器
2          起始地址高     01            地址0x0100
3          起始地址低     00            
4          寄存器数量高   00            写入3个寄存器
5          寄存器数量低   03            
6          字节数         06            3×2=6字节
7          数据1高字节    00            第1个寄存器数据
8          数据1低字节    01            
9          数据2高字节    00            第2个寄存器数据
10         数据2低字节    01            
11         数据3高字节    0B            第3个寄存器数据
12         数据3低字节    B8            目标转速=3000rpm
13         CRC校验低字节  XX            CRC16-Modbus
14         CRC校验高字节  XX            CRC16-Modbus
```

#### 响应帧格式
```
字节索引   字段名称       示例值(Hex)   说明
----------------------------------------------
0          从站地址       01            
1          功能码         10            
2          起始地址高     01            
3          起始地址低     00            
4          寄存器数量高   00            
5          寄存器数量低   03            
6          CRC校验低字节  XX            
7          CRC校验高字节  XX            
```

### 5.4 异常响应帧格式
```
字节索引   字段名称       示例值(Hex)   说明
----------------------------------------------
0          从站地址       01            
1          功能码+0x80    83            0x03+0x80=0x83
2          异常码         02            非法地址
3          CRC校验低字节  XX            
4          CRC校验高字节  XX            
```

---

## 六、CRC16校验算法

### 6.1 Modbus CRC16算法
```c
// CRC16-Modbus多项式: 0xA001
uint16_t crc16_modbus(uint8_t *data, uint16_t length) {
    uint16_t crc = 0xFFFF;  // 初始值
    
    for (uint16_t i = 0; i < length; i++) {
        crc ^= data[i];  // XOR字节
        
        for (uint8_t j = 0; j < 8; j++) {
            if (crc & 0x0001) {
                crc = (crc >> 1) ^ 0xA001;  // 多项式
            } else {
                crc = crc >> 1;
            }
        }
    }
    
    return crc;  // 低字节在前,高字节在后
}
```

### 6.2 使用示例
```c
uint8_t frame[] = {0x01, 0x03, 0x00, 0x00, 0x00, 0x10};
uint16_t crc = crc16_modbus(frame, 6);
frame[6] = crc & 0xFF;        // CRC低字节
frame[7] = (crc >> 8) & 0xFF; // CRC高字节
```

---

## 七、DTU通讯流程

### 7.1 主站轮询与从站响应 (DTU_EMS→DTU_FOC→DTU_EMS)

#### 流程说明
1. **DTU_EMS主动轮询**: 按20ms周期发送0x03读取请求
2. **DTU_FOC响应**: 收到请求后<10ms内响应
3. **DTU_EMS接收**: 解析数据并更新缓冲区
4. **EMS主控读取**: 从DTU_EMS缓冲区读取最新状态

#### 典型轮询序列
```
周期1 (0ms):   读取状态寄存器  0x0000-0x000F (16个)
周期2 (20ms):  读取控制环状态  0x0010-0x001F (16个)
周期3 (40ms):  读取故障寄存器  0x0300 (1个)
周期4 (60ms):  读取状态寄存器  0x0000-0x000F (循环)
```

### 7.2 下行通讯 (DTU_EMS → DTU_FOC)

#### 流程说明
1. **EMS下发指令**: 写入DTU_EMS发送缓冲区
2. **DTU_EMS发送**: 使用0x06/0x10功能码发送
3. **DTU_FOC执行**: 解析指令并执行
4. **DTU_FOC响应**: 返回执行结果
5. **DTU_EMS确认**: 检查响应,确认执行成功

#### 典型控制序列
```c
// 启动电机示例
步骤1: 写入控制模式 (0x0101 = 1, 速度模式)
步骤2: 写入目标转速 (0x0102 = 3000rpm)
步骤3: 写入运行使能 (0x0100 = 1, 使能)
步骤4: 等待100ms
步骤5: 读取运行状态 (0x0000) 确认已启动
```

### 7.3 异常处理

#### 超时处理
```
- 发送超时: 100ms无响应则重传,最多3次
- 连续失败: 3次重传失败则上报EMS主控
- 故障恢复: 故障消失后自动恢复轮询
```

#### 数据校验
```
- CRC错误: 丢弃数据,请求重传
- 地址错误: 记录异常日志
- 数据越界: 使用默认值或上次有效值
```

---

## 八、DTU配置参数

### 8.1 DTU_EMS配置
```c
// 主站配置
modbus_master_config_t ems_dtu_config = {
    .uart_port = UART1,
    .baudrate = 115200,
    .timeout_ms = 100,
    .retry_times = 3,
    .poll_interval_ms = 20,
    .tx_buffer_size = 256,
    .rx_buffer_size = 256
};
```

### 8.2 DTU_FOC配置
```c
// 从站配置
modbus_slave_config_t foc_dtu_config = {
    .uart_port = UART2,
    .slave_address = 1,
    .baudrate = 115200,
    .response_delay_us = 5000,  // 5ms响应延时
    .tx_buffer_size = 256,
    .rx_buffer_size = 256,
    .param_save_enable = true   // 参数掉电保存
};
```

---

## 九、典型应用场景

### 9.1 电机启动控制
```c
// 1. 设置控制模式为速度模式
modbus_write_single_reg(0x01, 0x0101, 0x0001);

// 2. 设置目标转速3000rpm
modbus_write_single_reg(0x01, 0x0102, 3000);

// 3. 设置加速时间2秒
modbus_write_single_reg(0x01, 0x0105, 2000);

// 4. 使能运行
modbus_write_single_reg(0x01, 0x0100, 0x0001);

// 5. 读取运行状态确认
uint16_t status;
modbus_read_holding_regs(0x01, 0x0000, 1, &status);
```

### 9.2 故障复位
```c
// 1. 读取故障码
uint16_t fault_code;
modbus_read_holding_regs(0x01, 0x0300, 1, &fault_code);

// 2. 确认故障已消除

// 3. 发送故障复位指令
modbus_write_single_reg(0x01, 0x010A, 0x0001);

// 4. 延时100ms

// 5. 读取故障码确认清除
modbus_read_holding_regs(0x01, 0x0300, 1, &fault_code);
```

### 9.3 参数批量配置
```c
// 使用0x10功能码批量写入PID参数
uint16_t pid_params[6] = {
    500,  // 速度环P
    100,  // 速度环I
    800,  // 位置环P
    50,   // 位置环I
    300,  // 电流环P
    150   // 电流环I
};
modbus_write_multiple_regs(0x01, 0x020D, 6, pid_params);
```

---

## 十、DTU故障诊断

### 10.1 常见故障及处理

| 故障现象 | 可能原因 | 排查方法 |
|---------|---------|---------|
| 无响应 | 波特率不匹配 | 检查双方波特率配置 |
| CRC错误 | 线路干扰/接触不良 | 检查RS485线缆 |
| 地址错误 | 从站地址配置错误 | 读取0x0200寄存器 |
| 超时 | FOC模块故障 | 检查FOC模块电源和状态 |
| 数据异常 | 寄存器地址错误 | 核对寄存器映射表 |

### 10.2 调试工具建议
- **Modbus Poll**: PC端Modbus主站模拟工具
- **Modbus Slave**: PC端Modbus从站模拟工具
- **逻辑分析仪**: 捕获RS485波形分析

---

## 十一、性能指标

| 指标名称 | 数值 | 说明 |
|---------|------|------|
| 轮询周期 | 20ms | 实时状态更新周期 |
| 响应延时 | <10ms | FOC响应时间 |
| 数据刷新率 | 50Hz | 每秒50次状态更新 |
| 指令执行时间 | <50ms | 从发送到确认的时间 |
| 通讯可靠性 | >99.9% | CRC校验+重传机制 |
| 最大从站数 | 247 | Modbus协议限制 |

---

## 十二、注意事项

### 12.1 实时性要求
- 电机控制对实时性要求高,建议轮询周期≤20ms
- 紧急停止指令应优先处理
- 避免在控制过程中进行参数写入

### 12.2 参数修改
- 参数寄存器(0x0200-0x02FF)修改后需重启生效
- 控制寄存器(0x0100-0x01FF)修改立即生效
- 建议在停机状态下修改参数

### 12.3 故障处理
- 发生严重故障(如Bit0/1/10/11,对应过流/过压/硬件/IGBT)后,需手动复位
- 故障复位前需确认故障已消除
- 故障记录会保存在EEPROM中

---

**文档版本**: v1.0  
**编制日期**: 2025-12-20  
**协议类型**: Modbus RTU  
**通信接口**: RS485  
