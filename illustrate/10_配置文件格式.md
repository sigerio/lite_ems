# 配置文件格式

## 一、概述

### 1.1 适用范围
本文档定义EMS系统所有配置文件的完整schema，包括字段类型、取值范围、默认值和校验规则。

### 1.2 配置文件列表
| 文件名 | 路径 | 用途 |
|--------|------|------|
| system.json | /opt/ems/config/ | 系统级配置 |
| devices.json | /opt/ems/config/ | 设备配置 |
| network.json | /opt/ems/config/ | 网络配置 |

### 1.3 通用规则
| 规则 | 说明 |
|------|------|
| 编码 | UTF-8 |
| 格式 | JSON |
| 版本字段 | 所有配置文件必须包含version字段 |
| 未知字段 | 解析时忽略未知字段（向前兼容） |
| 缺失字段 | 使用默认值 |

---

## 二、system.json - 系统配置

### 2.1 完整Schema
```json
{
  "version": "1.0",
  "log": {
    "level": "INFO",
    "max_size_mb": 10,
    "max_files": 50,
    "console_output": true
  },
  "data": {
    "history_days": 30,
    "alarm_days": 90,
    "stats_days": 365,
    "sample_interval_ms": 1000
  },
  "terminal": {
    "port": 9000,
    "max_connections": 5,
    "heartbeat_interval_s": 10,
    "heartbeat_timeout_s": 30,
    "token_expires_s": 1800
  },
  "system": {
    "startup_timeout_s": 60,
    "shutdown_timeout_s": 30,
    "watchdog_enabled": true,
    "watchdog_timeout_s": 60
  }
}
```

### 2.2 字段说明

#### 2.2.1 version
| 属性 | 值 |
|------|-----|
| 类型 | string |
| 必填 | 是 |
| 默认值 | "1.0" |
| 说明 | 配置文件版本号 |

#### 2.2.2 log - 日志配置
| 字段 | 类型 | 必填 | 默认值 | 范围 | 说明 |
|------|------|------|--------|------|------|
| level | string | 否 | "INFO" | ERROR/WARN/INFO/DEBUG/TRACE | 日志级别 |
| max_size_mb | number | 否 | 10 | 1-100 | 单个日志文件大小(MB) |
| max_files | number | 否 | 50 | 1-100 | 最大日志文件数 |
| console_output | boolean | 否 | true | - | 是否输出到控制台 |

#### 2.2.3 data - 数据配置
| 字段 | 类型 | 必填 | 默认值 | 范围 | 说明 |
|------|------|------|--------|------|------|
| history_days | number | 否 | 30 | 1-365 | 历史数据保留天数 |
| alarm_days | number | 否 | 90 | 1-365 | 告警记录保留天数 |
| stats_days | number | 否 | 365 | 1-730 | 统计数据保留天数 |
| sample_interval_ms | number | 否 | 1000 | 100-10000 | 数据采集间隔(ms) |

#### 2.2.4 terminal - 终端配置
| 字段 | 类型 | 必填 | 默认值 | 范围 | 说明 |
|------|------|------|--------|------|------|
| port | number | 否 | 9000 | 1024-65535 | 终端服务端口 |
| max_connections | number | 否 | 5 | 1-10 | 最大连接数 |
| heartbeat_interval_s | number | 否 | 10 | 5-60 | 心跳间隔(秒) |
| heartbeat_timeout_s | number | 否 | 30 | 10-120 | 心跳超时(秒) |
| token_expires_s | number | 否 | 1800 | 300-86400 | Token有效期(秒) |

#### 2.2.5 system - 系统配置
| 字段 | 类型 | 必填 | 默认值 | 范围 | 说明 |
|------|------|------|--------|------|------|
| startup_timeout_s | number | 否 | 60 | 30-300 | 启动超时(秒) |
| shutdown_timeout_s | number | 否 | 30 | 10-120 | 关机超时(秒) |
| watchdog_enabled | boolean | 否 | true | - | 是否启用看门狗 |
| watchdog_timeout_s | number | 否 | 60 | 30-300 | 看门狗超时(秒) |

---

## 三、devices.json - 设备配置

### 3.1 完整Schema
```json
{
  "version": "1.0",
  "foc_devices": [
    {
      "device_id": "FOC001",
      "modbus_addr": 1,
      "serial_port": "/dev/ttyS3",
      "baudrate": 115200,
      "data_bits": 8,
      "stop_bits": 1,
      "parity": "none",
      "poll_interval_ms": 100,
      "timeout_ms": 500,
      "retry_count": 3,
      "enabled": true
    }
  ],
  "bms_devices": [
    {
      "device_id": "BMS001",
      "asdu_addr": 1,
      "ip": "192.168.1.101",
      "port": 2404,
      "t1_timeout_s": 15,
      "t2_timeout_s": 10,
      "t3_timeout_s": 20,
      "k_max_unack": 12,
      "w_ack_threshold": 8,
      "reconnect_interval_s": 10,
      "enabled": true
    }
  ],
  "charger_devices": [
    {
      "device_id": "CP001",
      "charge_point_id": "CP001",
      "vendor": "EMS",
      "model": "AC7KW",
      "serial_number": "SN202401001",
      "heartbeat_interval_s": 300,
      "enabled": true
    }
  ]
}
```

### 3.2 FOC设备配置

#### 3.2.1 字段说明
| 字段 | 类型 | 必填 | 默认值 | 范围 | 说明 |
|------|------|------|--------|------|------|
| device_id | string | 是 | - | FOC001-FOC005 | 设备唯一标识 |
| modbus_addr | number | 是 | - | 1-247 | Modbus从站地址 |
| serial_port | string | 否 | "/dev/ttyS3" | - | 串口设备路径 |
| baudrate | number | 否 | 115200 | 9600/19200/38400/57600/115200 | 波特率 |
| data_bits | number | 否 | 8 | 7/8 | 数据位 |
| stop_bits | number | 否 | 1 | 1/2 | 停止位 |
| parity | string | 否 | "none" | none/odd/even | 校验位 |
| poll_interval_ms | number | 否 | 100 | 50-1000 | 轮询间隔(ms) |
| timeout_ms | number | 否 | 500 | 100-5000 | 通讯超时(ms) |
| retry_count | number | 否 | 3 | 0-10 | 重试次数 |
| enabled | boolean | 否 | true | - | 是否启用 |

#### 3.2.2 device_id格式
```
格式: FOC + 3位数字
示例: FOC001, FOC002, ..., FOC005
正则: ^FOC00[1-5]$
```

### 3.3 BMS设备配置

#### 3.3.1 字段说明
| 字段 | 类型 | 必填 | 默认值 | 范围 | 说明 |
|------|------|------|--------|------|------|
| device_id | string | 是 | - | BMS001-BMS005 | 设备唯一标识 |
| asdu_addr | number | 是 | - | 1-65535 | IEC104公共地址 |
| ip | string | 是 | - | IPv4格式 | 设备IP地址 |
| port | number | 否 | 2404 | 1-65535 | TCP端口 |
| t1_timeout_s | number | 否 | 15 | 1-255 | 发送超时(秒) |
| t2_timeout_s | number | 否 | 10 | 1-255 | 确认超时(秒) |
| t3_timeout_s | number | 否 | 20 | 1-255 | 测试帧超时(秒) |
| k_max_unack | number | 否 | 12 | 1-32767 | 最大未确认I帧数 |
| w_ack_threshold | number | 否 | 8 | 1-32767 | 确认阈值 |
| reconnect_interval_s | number | 否 | 10 | 5-300 | 重连间隔(秒) |
| enabled | boolean | 否 | true | - | 是否启用 |

#### 3.3.2 device_id格式
```
格式: BMS + 3位数字
示例: BMS001, BMS002, ..., BMS005
正则: ^BMS00[1-5]$
```

### 3.4 充电桩设备配置

#### 3.4.1 字段说明
| 字段 | 类型 | 必填 | 默认值 | 范围 | 说明 |
|------|------|------|--------|------|------|
| device_id | string | 是 | - | CP001-CP005 | 设备唯一标识 |
| charge_point_id | string | 是 | - | - | OCPP充电桩标识 |
| vendor | string | 否 | "EMS" | - | 厂商名称 |
| model | string | 否 | "" | - | 设备型号 |
| serial_number | string | 否 | "" | - | 序列号 |
| heartbeat_interval_s | number | 否 | 300 | 60-3600 | 心跳间隔(秒) |
| enabled | boolean | 否 | true | - | 是否启用 |

#### 3.4.2 device_id格式
```
格式: CP + 3位数字
示例: CP001, CP002, ..., CP005
正则: ^CP00[1-5]$
```

---

## 四、network.json - 网络配置

### 4.1 完整Schema
```json
{
  "version": "1.0",
  "wifi": {
    "mode": "ap",
    "ssid": "EMS_AP",
    "password": "ems12345",
    "channel": 6,
    "hidden": false,
    "max_clients": 10
  },
  "eth": {
    "enabled": false,
    "dhcp": true,
    "ip": "",
    "netmask": "",
    "gateway": "",
    "dns1": "",
    "dns2": ""
  },
  "ocpp": {
    "port": 8080,
    "path_prefix": "/ocpp"
  }
}
```

### 4.2 WiFi配置

#### 4.2.1 字段说明
| 字段 | 类型 | 必填 | 默认值 | 范围 | 说明 |
|------|------|------|--------|------|------|
| mode | string | 否 | "ap" | ap/sta | WiFi模式 |
| ssid | string | 是 | "EMS_AP" | 1-32字符 | 网络名称 |
| password | string | 是 | "ems12345" | 8-63字符 | 密码(WPA2) |
| channel | number | 否 | 6 | 1-13 | 信道(AP模式) |
| hidden | boolean | 否 | false | - | 隐藏SSID |
| max_clients | number | 否 | 10 | 1-32 | 最大客户端数(AP模式) |

#### 4.2.2 mode说明
| 值 | 说明 |
|-----|------|
| ap | 接入点模式，EMS作为热点 |
| sta | 站点模式，EMS连接到路由器 |

### 4.3 以太网配置

#### 4.3.1 字段说明
| 字段 | 类型 | 必填 | 默认值 | 范围 | 说明 |
|------|------|------|--------|------|------|
| enabled | boolean | 否 | false | - | 是否启用以太网 |
| dhcp | boolean | 否 | true | - | 是否使用DHCP |
| ip | string | 条件 | "" | IPv4格式 | 静态IP(dhcp=false时必填) |
| netmask | string | 条件 | "" | IPv4格式 | 子网掩码 |
| gateway | string | 条件 | "" | IPv4格式 | 网关 |
| dns1 | string | 否 | "" | IPv4格式 | 首选DNS |
| dns2 | string | 否 | "" | IPv4格式 | 备用DNS |

### 4.4 OCPP配置

#### 4.4.1 字段说明
| 字段 | 类型 | 必填 | 默认值 | 范围 | 说明 |
|------|------|------|--------|------|------|
| port | number | 否 | 8080 | 1024-65535 | WebSocket端口 |
| path_prefix | string | 否 | "/ocpp" | - | URL路径前缀 |

---

## 五、默认配置值汇总

### 5.1 system.json默认值
```json
{
  "version": "1.0",
  "log": {
    "level": "INFO",
    "max_size_mb": 10,
    "max_files": 50,
    "console_output": true
  },
  "data": {
    "history_days": 30,
    "alarm_days": 90,
    "stats_days": 365,
    "sample_interval_ms": 1000
  },
  "terminal": {
    "port": 9000,
    "max_connections": 5,
    "heartbeat_interval_s": 10,
    "heartbeat_timeout_s": 30,
    "token_expires_s": 1800
  },
  "system": {
    "startup_timeout_s": 60,
    "shutdown_timeout_s": 30,
    "watchdog_enabled": true,
    "watchdog_timeout_s": 60
  }
}
```

### 5.2 devices.json默认值
```json
{
  "version": "1.0",
  "foc_devices": [],
  "bms_devices": [],
  "charger_devices": []
}
```

### 5.3 network.json默认值
```json
{
  "version": "1.0",
  "wifi": {
    "mode": "ap",
    "ssid": "EMS_AP",
    "password": "ems12345",
    "channel": 6,
    "hidden": false,
    "max_clients": 10
  },
  "eth": {
    "enabled": false,
    "dhcp": true,
    "ip": "",
    "netmask": "",
    "gateway": "",
    "dns1": "",
    "dns2": ""
  },
  "ocpp": {
    "port": 8080,
    "path_prefix": "/ocpp"
  }
}
```

---

## 六、配置校验规则

### 6.1 通用校验
| 规则 | 说明 |
|------|------|
| JSON格式 | 必须是合法的JSON |
| version字段 | 必须存在且为字符串 |
| 类型校验 | 字段类型必须匹配定义 |
| 范围校验 | 数值必须在定义范围内 |

### 6.2 设备配置校验
| 规则 | 说明 |
|------|------|
| device_id唯一 | 同类型设备ID不能重复 |
| device_id格式 | 必须符合正则表达式 |
| 地址唯一 | modbus_addr/asdu_addr不能重复 |
| IP格式 | 必须是合法的IPv4地址 |

### 6.3 校验失败处理
| 场景 | 处理 |
|------|------|
| 文件不存在 | 创建默认配置文件 |
| JSON解析失败 | 尝试从.bak恢复 |
| 字段类型错误 | 使用默认值，记录警告 |
| 字段范围错误 | 使用默认值，记录警告 |
| 必填字段缺失 | 使用默认值，记录警告 |

---

## 七、配置示例

### 7.1 单FOC设备配置
```json
{
  "version": "1.0",
  "foc_devices": [
    {
      "device_id": "FOC001",
      "modbus_addr": 1,
      "enabled": true
    }
  ],
  "bms_devices": [],
  "charger_devices": []
}
```

### 7.2 完整多设备配置
```json
{
  "version": "1.0",
  "foc_devices": [
    {"device_id": "FOC001", "modbus_addr": 1, "enabled": true},
    {"device_id": "FOC002", "modbus_addr": 2, "enabled": false}
  ],
  "bms_devices": [
    {"device_id": "BMS001", "asdu_addr": 1, "ip": "192.168.1.101", "enabled": true}
  ],
  "charger_devices": [
    {"device_id": "CP001", "charge_point_id": "CP001", "enabled": true}
  ]
}
```

### 7.3 静态IP网络配置
```json
{
  "version": "1.0",
  "wifi": {
    "mode": "ap",
    "ssid": "EMS_Factory",
    "password": "factory123"
  },
  "eth": {
    "enabled": true,
    "dhcp": false,
    "ip": "192.168.1.100",
    "netmask": "255.255.255.0",
    "gateway": "192.168.1.1",
    "dns1": "8.8.8.8"
  },
  "ocpp": {
    "port": 8080
  }
}
```

---

## 八、注意事项

### 8.1 配置文件安全
- WiFi密码以明文存储，确保文件权限为644
- 生产环境建议修改默认密码
- 配置文件不应包含敏感凭证

### 8.2 配置变更
- system.json变更需重启EMS
- network.json变更需重启EMS
- devices.json的enabled字段支持热加载

### 8.3 版本兼容
- 新版本EMS应能读取旧版本配置
- 缺失的新字段使用默认值
- 未知字段被忽略

---

**文档版本**: v1.0
**编制日期**: 2025-12-30
**适用范围**: EMS配置文件管理
